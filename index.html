<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‡ªå®šä¹‰æˆ‘çš„æ™ºèƒ½å·¥å…·ç®± </title>
    <style>
        :root {
            --bg-image: none;
            --bg-overlay: rgba(255, 255, 255, 0.85);
            --bg-color: #ffffff;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            color: #333;
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
            position: relative;
            padding-top: 40px;
        }
        
        /* =============== ç”¨æˆ·å®¹å™¨æ ·å¼ =============== */
        .user-container {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 10px;
            transition: all 0.3s ease;
        }
        
        .user-container.logged-in {
            opacity: 0.8;
            transform: scale(0.95);
        }
        
        .user-container.logged-in:hover {
            opacity: 1;
            transform: scale(1);
        }
        
        .user-info {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 12px 18px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 12px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(52, 152, 219, 0.2);
            transition: all 0.3s ease;
            max-width: 300px;
        }
        
        .user-info.logged-in {
            padding: 10px 15px;
        }
        
        .user-avatar {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3498db, #9b59b6);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 18px;
            position: relative;
            overflow: hidden;
            border: 2px solid white;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.15);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .user-avatar:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .user-details {
            flex: 1;
            min-width: 0;
        }
        
        .user-name {
            font-weight: 600;
            font-size: 14px;
            color: #2c3e50;
            margin-bottom: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .user-email {
            font-size: 12px;
            color: #7f8c8d;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .user-actions {
            display: flex;
            gap: 6px;
        }
        
        .user-btn {
            background: #3498db;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 6px 10px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 4px;
            white-space: nowrap;
        }
        
        .user-btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }
        
        .user-btn-logout {
            background: #e74c3c;
        }
        
        .user-btn-logout:hover {
            background: #c0392b;
        }

        
	/* åŒæ­¥æŒ‰é’®çš„ç‰¹æ®Šæ ·å¼ */
	.user-btn[onclick="manualCloudSync()"] {
	    background: #2ecc71;
	}

	.user-btn[onclick="manualCloudSync()"]:hover {
	    background: #27ae60;
	}


        /* å³ä¸Šè§’æ—¶é—´æ˜¾ç¤º */
        .global-time-display {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 100;
            text-align: center;
            color: #2c3e50;
            font-family: 'Segoe UI', monospace;
            background: none;
            padding: 0;
        }
        
        .global-date {
            font-size: 14px;
            margin-bottom: 4px;
            color: #666;
        }
        
        .global-time {
            font-size: 32px;
            font-weight: 700;
            color: #2c3e50;
            letter-spacing: 1px;
        }
        
        /* èƒŒæ™¯å›¾ç‰‡å±‚ */
        .page-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -2;
            background: var(--bg-color) var(--bg-image) center/cover no-repeat;
        }
        
        .page-background::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-overlay);
            backdrop-filter: blur(3px);
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }
        
        /* =============== ç”¨æˆ·ç›¸å…³æ¨¡æ€æ¡† =============== */
        .user-modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            width: 90%;
            max-width: 420px;
            animation: modalSlideIn 0.3s ease;
        }
        
        .auth-tabs {
            display: flex;
            margin-bottom: 25px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .auth-tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            background: none;
            border: none;
            font-size: 16px;
            font-weight: 600;
            color: #95a5a6;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        
        .auth-tab.active {
            color: #3498db;
        }
        
        .auth-tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 100%;
            height: 2px;
            background: #3498db;
        }
        
        .auth-form {
            display: none;
        }
        
        .auth-form.active {
            display: block;
        }
        
        .form-footer {
            margin-top: 20px;
            text-align: center;
            font-size: 14px;
            color: #7f8c8d;
        }
        
        .form-footer a {
            color: #3498db;
            text-decoration: none;
            font-weight: 500;
            cursor: pointer;
        }
        
        .form-footer a:hover {
            text-decoration: underline;
        }
        
        /* å¤´åƒä¸Šä¼ åŒºåŸŸ */
        .avatar-upload-container {
            margin-bottom: 20px;
            text-align: center;
        }
        
        .avatar-preview {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            margin: 0 auto 15px;
            background: #f0f2f5;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border: 3px solid #e9ecef;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .avatar-preview:hover {
            border-color: #3498db;
            transform: scale(1.05);
        }
        
        .avatar-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .avatar-placeholder {
            font-size: 36px;
            color: #95a5a6;
        }
        
        .avatar-upload-btn {
            display: inline-block;
            padding: 8px 16px;
            background: #3498db;
            color: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }
        
        .avatar-upload-btn:hover {
            background: #2980b9;
        }
        
        /* ç¼–è¾‘å¤´åƒæ¨¡æ€æ¡† */
        #avatarModal .user-modal-content {
            max-width: 350px;
        }
        
        /* æ”¹è¿›çš„æœç´¢å®¹å™¨æ ·å¼ */
        .search-container {
            background: white;
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .search-input-row {
            display: flex;
            gap: 10px;
            align-items: center;
            width: 100%;
        }
        
        .search-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .search-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        .search-options {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            padding-top: 5px;
            border-top: 1px solid #f0f0f0;
            margin-top: 5px;
        }
        
        .search-engine-selector {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        
        .search-engine-btn {
            padding: 6px 12px;
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            color: #495057;
            transition: all 0.2s;
            white-space: nowrap;
        }
        
        .search-engine-btn:hover {
            background: #e9ecef;
            border-color: #dee2e6;
        }
        
        .search-engine-btn.active {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }
        
        .search-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: #495057;
            margin-left: auto;
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 22px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 22px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: #27ae60;
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(22px);
        }
        
        .search-btn {
            padding: 12px 24px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
            min-width: 100px;
        }
        
        .search-btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }
        
        .search-hint {
            font-size: 12px;
            color: #6c757d;
            margin-top: 5px;
            padding-left: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .search-hint-icon {
            font-size: 14px;
        }
        
        .search-results {
            background: white;
            border-radius: 10px;
            margin-top: 10px;
            max-height: 300px;
            overflow-y: auto;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            display: none;
        }
        
        .search-result-item {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .search-result-item:hover {
            background: #f8f9fa;
        }
        
        .search-result-item:last-child {
            border-bottom: none;
        }
        
        .search-result-icon {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }
        
        .search-result-info {
            flex: 1;
        }
        
        .search-result-name {
            font-weight: 600;
            font-size: 14px;
            color: #2c3e50;
        }
        
        .search-result-desc {
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 4px;
        }
        
        .search-result-module {
            font-size: 12px;
            color: #95a5a6;
            background: #f0f2f5;
            padding: 2px 8px;
            border-radius: 4px;
            white-space: nowrap;
        }
        
        .no-results {
            padding: 30px;
            text-align: center;
            color: #95a5a6;
        }
        
        /* å…³äºæœ¬ç«™æŒ‰é’® */
        .about-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(52, 152, 219, 0.9);
            color: white;
            border: none;
            border-radius: 50px;
            padding: 8px 16px;
            font-size: 12px;
            cursor: pointer;
            z-index: 100;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .about-btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
        }
        
        /* ä»‹ç»æ æ ·å¼ - å¯è®¾ç½®èƒŒæ™¯è‰²å’Œé€æ˜åº¦ */
        .introduction-panel {
            background: rgba(102, 126, 234, 0.9); /* é»˜è®¤é¢œè‰²ï¼Œå¯ç¼–è¾‘ */
            color: white;
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(102, 126, 234, 0.3);
            position: relative;
            overflow: hidden;
            margin-top: 20px; /* å‘ä¸‹ç§»åŠ¨ */
        }
        
        .introduction-panel::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -20%;
            width: 300px;
            height: 300px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
        }
        
        .introduction-header {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
            position: relative;
            z-index: 1;
            flex-direction: column;
        }
        
        .introduction-title {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .introduction-content-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            width: 100%;
        }
        
        .introduction-content {
            font-size: 1.1rem;
            line-height: 1.8;
            opacity: 0.95;
            position: relative;
            z-index: 1;
            text-align: center;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .introduction-edit-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 6px 15px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
            white-space: nowrap;
            margin: 5px 0;
        }
        
        .introduction-edit-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }
        
        .introduction-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 10px;
        }
        
        /* æ§åˆ¶é¢æ¿ */
        .control-panel {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.08);
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .btn {
            padding: 10px 20px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: #95a5a6;
        }
        
        .btn-secondary:hover {
            background: #7f8c8d;
        }
        
        .btn-success {
            background: #27ae60;
        }
        
        .btn-success:hover {
            background: #219653;
        }
        
        .btn-bg {
            background: #9b59b6;
        }
        
        .btn-bg:hover {
            background: #8e44ad;
        }
        
        .btn-intro-bg {
            background: #bdc3c7;
        }
        
        .btn-intro-bg:hover {
            background: #c0392b;
        }
        
        .mode-indicator {
            margin-left: auto;
            padding: 8px 16px;
            background: #f8f9fa;
            border-radius: 20px;
            font-size: 14px;
            color: #555;
            border: 1px solid #e9ecef;
        }
        
        /* æ¨¡å—å®¹å™¨ - æ”¹ä¸ºæ¨ªå‘æ’åˆ— */
        .modules-container {
            display: flex;
            flex-direction: column;
            gap: 25px;
            margin-bottom: 50px;
        }
        
        /* æ¨¡å—æ ·å¼ - æ¯è¡Œä¸€ä¸ª */
        .module {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.08);
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
            cursor: move;
            width: 100%;
        }
        
        .module::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--module-color, #3498db), transparent);
        }
        
        .edit-mode .module {
            border: 2px dashed #3498db;
        }
        
        .module:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.12);
        }
        
        /* æ¨¡å—æ‹–æ‹½æ—¶çš„æ ·å¼ */
        .module.dragging {
            opacity: 0.8;
            transform: rotate(2deg) scale(1.02);
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            z-index: 1000;
        }
        
        /* æ¨¡å—å¤´éƒ¨ */
        .module-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f2f5;
        }
        
        .module-title {
            font-size: 1.4rem;
            font-weight: 600;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .module-title-icon {
            font-size: 1.2em;
        }
        
        .module-controls {
            display: flex;
            gap: 10px;
        }
        
        .control-btn {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .control-btn:hover {
            background: #e9ecef;
        }
        
        /* æ¨¡å—å†…å®¹åŒº */
        .module-content {
            min-height: 100px;
            position: relative;
        }
        
        .module-content.grid-layout {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
        }
        
        .module-content.list-layout {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .module-content.card-layout {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 15px;
        }

        /* å·¥å…·é¡¹ç›®æ ·å¼ - ç»Ÿä¸€è°ƒæ•´ä¸ºå°å‹å¡ç‰‡æ ·å¼ */
        .tool-item {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px 12px;
            text-decoration: none;
            color: #333;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            position: relative;
            cursor: pointer;
            border: 1px solid transparent;
            text-align: center;
            min-height: 100px;
            justify-content: space-between;
        }

        .tool-item:hover {
            background: #e9ecef;
            transform: translateY(-3px);
            border-color: #3498db;
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.1);
        }

        /* å·¥å…·å›¾æ ‡å®¹å™¨ - åœ¨é¡¶éƒ¨å±…ä¸­ï¼Œå°ºå¯¸è°ƒå° */
        .tool-icon {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            border-radius: 8px;
            font-size: 18px;
            color: #3498db;
            flex-shrink: 0;
            overflow: hidden;
            box-shadow: 0 3px 8px rgba(0,0,0,0.08);
            margin-bottom: 6px;
        }

        .tool-icon img {
            width: 20px;
            height: 20px;
            object-fit: contain;
            max-width: 100%;
            max-height: 100%;
        }

        /* å·¥å…·ä¿¡æ¯ - æ–‡å­—åœ¨å›¾æ ‡ä¸‹æ–¹å±…ä¸­ */
        .tool-info {
            flex: 1;
            min-width: 0;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .tool-name {
            font-weight: 600;
            font-size: 13px;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 100%;
            text-align: center;
        }

        .tool-desc {
            font-size: 11px;
            color: #7f8c8d;
            line-height: 1.3;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            width: 100%;
            text-align: center;
        }

        .card-layout .tool-info {
            text-align: center;
            width: 100%;
        }

        /* ç¼–è¾‘æ¨¡å¼ä¸‹å·¥å…·é¡¹çš„æ ·å¼ */
        .edit-mode .tool-item {
            cursor: move;
        }

        .edit-mode .tool-dragging {
            opacity: 0.7;
            transform: rotate(3deg) scale(1.02);
            background: #bbdefb;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        /* å·¥å…·é¡¹æ‹–æ‹½å ä½æŒ‡ç¤ºå™¨ */
        .tool-placeholder {
            border: 2px dashed #3498db;
            background: rgba(52, 152, 219, 0.05);
            border-radius: 10px;
            height: 100px;
        }

        /* å·¥å…·é¡¹ä¸­çš„æ§åˆ¶æŒ‰é’® */
        .tool-controls {
            position: absolute;
            top: 6px;
            right: 6px;
            display: flex;
            gap: 4px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .edit-mode .tool-item:hover .tool-controls {
            opacity: 1;
        }

        .tool-edit-btn,
        .tool-delete-btn {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #3498db;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .tool-edit-btn:hover {
            background: #2980b9;
            transform: scale(1.1);
        }

        .tool-delete-btn {
            background: #e74c3c;
        }

        .tool-delete-btn:hover {
            background: #c0392b;
            transform: scale(1.1);
        }
        
        /* ç©ºæ¨¡å—æ ·å¼ */
        .empty-module {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            background: #f8f9fa;
            border: 2px dashed #ced4da;
            border-radius: 15px;
            color: #6c757d;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
        }
        
        .empty-module:hover {
            background: #e9ecef;
            border-color: #adb5bd;
        }
        
        .empty-module-icon {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }
        
        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            animation: modalSlideIn 0.3s ease;
        }
        
        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }
        
        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #95a5a6;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #2c3e50;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

/* å¯†ç è¾“å…¥æ¡†ç»„æ ·å¼ */
.password-input-group {
    position: relative;
    width: 100%;
}

.password-input-group input {
    padding-right: 40px !important;
    width: 100%;
}

.toggle-password {
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    color: #95a5a6;
    cursor: pointer;
    font-size: 16px;
    padding: 0;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: color 0.2s;
    z-index: 10;
}

.toggle-password:hover {
    color: #3498db;
}

.toggle-password:focus {
    outline: none;
}

        
        .bg-preview {
            width: 100%;
            height: 150px;
            border-radius: 10px;
            margin: 15px 0;
            background: var(--preview-bg, #f0f0f0) center/cover no-repeat;
            border: 2px dashed #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
        }
        
        .color-preview {
            width: 100%;
            height: 50px;
            border-radius: 8px;
            margin: 10px 0;
            border: 2px solid #ddd;
        }
        
        /* æ–‡ä»¶ä¸Šä¼ æ ·å¼ */
        .file-upload-container {
            margin-top: 10px;
        }
        
        .file-upload-btn {
            display: inline-block;
            padding: 8px 16px;
            background: #3498db;
            color: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
            margin-right: 10px;
        }
        
        .file-upload-btn:hover {
            background: #2980b9;
        }
        
        .file-name {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }
        
        /* èƒŒæ™¯ç±»å‹é€‰æ‹©å™¨ */
        .bg-type-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .bg-type-btn {
            flex: 1;
            padding: 10px;
            text-align: center;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .bg-type-btn.active {
            border-color: #3498db;
            background: #ebf5fb;
        }
        
        /* ç¼–è¾‘æ¨¡å¼ä¸‹çš„æ‹–æ‹½æ‰‹æŸ„ */
        .edit-mode .module::after {
            content: 'â‹®â‹®';
            position: absolute;
            top: 10px;
            left: 10px;
            color: #95a5a6;
            cursor: move;
            font-size: 18px;
            z-index: 10;
        }
        
        /* å…³äºæœ¬ç«™æ¨¡æ€æ¡†æ ·å¼ */
        .about-content {
            line-height: 1.8;
        }
        
        .about-section {
            margin-bottom: 20px;
        }
        
        .about-section h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .about-section p {
            color: #555;
            font-size: 14px;
        }
        
        .features-list {
            list-style: none;
            padding: 0;
        }
        
        .features-list li {
            padding: 5px 0;
            color: #555;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .features-list li:before {
            content: 'âœ“';
            color: #27ae60;
            font-weight: bold;
        }



/* =============== ç”¨æˆ·èœå•æ ·å¼ =============== */
.user-menu {
    position: absolute;
    top: 70px;
    left: 0;
    background: white;
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
    width: 280px;
    z-index: 1000;
    overflow: hidden;
    border: 1px solid rgba(52, 152, 219, 0.1);
    backdrop-filter: blur(10px);
    animation: slideDown 0.2s ease;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.user-menu-header {
    padding: 20px;
    background: linear-gradient(135deg, #3498db, #9b59b6);
    color: white;
    display: flex;
    align-items: center;
    gap: 15px;
}

.user-menu-avatar {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    border: 3px solid rgba(255, 255, 255, 0.3);
}

.user-menu-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.user-menu-info {
    flex: 1;
}

.user-menu-name {
    font-weight: 600;
    font-size: 16px;
    margin-bottom: 3px;
}

.user-menu-email {
    font-size: 13px;
    opacity: 0.9;
}

.user-menu-items {
    padding: 10px 0;
}

.user-menu-item {
    display: flex;
    align-items: center;
    padding: 12px 20px;
    cursor: pointer;
    transition: all 0.2s;
    gap: 12px;
}

.user-menu-item:hover {
    background: #f8f9fa;
}

.user-menu-icon {
    font-size: 18px;
    width: 24px;
    text-align: center;
}

.user-menu-text {
    font-size: 14px;
    color: #2c3e50;
}

/* ç‚¹å‡»å¤´åƒæ—¶çš„æ³¢çº¹æ•ˆæœ */
.user-avatar {
    position: relative;
    overflow: hidden;
}

.user-avatar::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.3);
    transform: translate(-50%, -50%);
    transition: width 0.3s, height 0.3s;
}

.user-avatar:active::after {
    width: 100%;
    height: 100%;
}

/* æ‰‹æœºç«¯é€‚é… */
@media (max-width: 768px) {
    .user-menu {
        position: fixed;
        top: 70px;
        left: 50%;
        transform: translateX(-50%);
        width: calc(100% - 40px);
        max-width: 300px;
        z-index: 2000;
    }
}
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .modules-container {
                grid-template-columns: 1fr;
            }
            
            .introduction-header {
                flex-direction: column;
                gap: 15px;
            }
            
            .introduction-content-container {
                flex-direction: column;
            }
            
            .control-panel {
                flex-direction: column;
                align-items: stretch;
            }
            
            .mode-indicator {
                margin-left: 0;
                text-align: center;
            }
            
            .bg-type-selector {
                flex-direction: column;
            }
            
            .global-time-display {
                position: relative;
                top: 0;
                right: 0;
                margin-bottom: 20px;
                text-align: center;
                width: 100%;
            }
            
            .global-time {
                font-size: 24px;
            }
            
            .user-container {
                position: relative;
                top: 0;
                left: 0;
                margin-bottom: 20px;
            }
            
            .search-container {
                flex-direction: column;
            }
            
            .search-input {
                width: 100%;
            }
            
            .search-btn {
                width: 100%;
                justify-content: center;
            }
            
            .search-input-row {
                flex-direction: column;
            }
            
            .search-engine-selector {
                justify-content: center;
            }
            
            .search-toggle {
                margin-left: 0;
                justify-content: center;
                width: 100%;
            }
            
            .about-btn {
                bottom: 10px;
                right: 10px;
                font-size: 11px;
                padding: 6px 12px;
            }
            
            .module-content.card-layout {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }
        }
    </style>
</head>
<body>
    <!-- ç”¨æˆ·å®¹å™¨ -->
    <div class="user-container" id="userContainer">
        <!-- ç”¨æˆ·ä¿¡æ¯ä¼šåŠ¨æ€ç”Ÿæˆ -->
    </div>
    
    <!-- å³ä¸Šè§’æ—¶é—´æ˜¾ç¤º -->
    <div class="global-time-display">
        <div class="global-date" id="globalCurrentDate">2026å¹´1æœˆ28æ—¥ æ˜ŸæœŸä¸‰</div>
        <div class="global-time" id="globalCurrentTime">16:01</div>
    </div>
    
    <!-- å…³äºæœ¬ç«™æŒ‰é’® -->
    <button class="about-btn" onclick="showAboutModal()">â„¹ï¸ å…³äºæœ¬ç«™</button>
    
    <!-- èƒŒæ™¯å›¾ç‰‡å±‚ -->
    <div class="page-background" id="pageBackground"></div>
    
    <div class="container">
        <!-- ä»‹ç»æ  -->
        <div class="introduction-panel" id="introductionPanel">
            <div class="introduction-header">
                <div class="introduction-title" id="introTitle">ğŸŒŸ æˆ‘çš„æ™ºèƒ½å·¥å…·ç®±</div>
                <div class="introduction-content-container">
                    <div class="introduction-content" id="introContent">
                        è¿™æ˜¯ä¸€ä¸ªå®Œå…¨è‡ªå®šä¹‰çš„å·¥å…·ç®±ï¼Œæ‚¨å¯ä»¥è‡ªç”±æ·»åŠ ã€åˆ é™¤å’Œæ‹–æ‹½æ’åºå„ç±»å·¥å…·ã€‚å°†æ‚¨æœ€å¸¸ç”¨çš„ç½‘ç«™å’Œå·¥å…·é›†ä¸­åœ¨è¿™é‡Œï¼Œæé«˜å·¥ä½œå’Œå­¦ä¹ æ•ˆç‡ï¼
                    </div>
                    <div class="introduction-controls">
                        <button class="introduction-edit-btn" onclick="showIntroductionModal()">ç¼–è¾‘ä»‹ç»</button>
                        <button class="introduction-edit-btn btn-intro-bg" onclick="showIntroductionBackgroundModal()">è®¾ç½®æ¨¡å—èƒŒæ™¯</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- æ”¹è¿›çš„æœç´¢åŠŸèƒ½ -->
        <div class="search-container">
            <div class="search-input-row">
                <input type="text" class="search-input" id="searchInput" 
                       placeholder="ğŸ” è¾“å…¥å…³é”®è¯æœç´¢..." 
                       onkeyup="handleSearchInput(event)">
                <button class="search-btn" onclick="performSearch()">
                    <span id="searchBtnText">ç™¾åº¦æœç´¢</span>
                </button>
            </div>
            
            <div class="search-options">
                <div class="search-engine-selector">
                    <button class="search-engine-btn active" data-engine="baidu" onclick="selectSearchEngine('baidu')">
                        ğŸ” ç™¾åº¦
                    </button>
                    <button class="search-engine-btn" data-engine="google" onclick="selectSearchEngine('google')">
                        ğŸŒ Google
                    </button>
                    <button class="search-engine-btn" data-engine="bing" onclick="selectSearchEngine('bing')">
                        ğŸ¯ Bing
                    </button>
                    <button class="search-engine-btn" data-engine="zhihu" onclick="selectSearchEngine('zhihu')">
                        ğŸ’¡ çŸ¥ä¹
                    </button>
                    <button class="search-engine-btn" data-engine="github" onclick="selectSearchEngine('github')">
                        ğŸ’» GitHub
                    </button>
                </div>
                
                <div class="search-toggle">
                    <span>ç«™å†…æœç´¢</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="siteSearchToggle" onchange="toggleSiteSearch()">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>
            
            <div class="search-hint" id="searchHint">
                <span class="search-hint-icon">ğŸ’¡</span>
                <span>æŒ‰ Enter é”®æˆ–ç‚¹å‡»æœç´¢æŒ‰é’®è¿›è¡Œç½‘é¡µæœç´¢</span>
            </div>
        </div>
        
        <div class="search-results" id="searchResults"></div>
        
        <!-- æ§åˆ¶é¢æ¿ -->
        <div class="control-panel">
            <button class="btn" onclick="toggleEditMode()">
                <span id="editIcon">âœï¸</span>
                <span id="editText">è¿›å…¥ç¼–è¾‘æ¨¡å¼</span>
            </button>
            
            <button class="btn btn-bg" onclick="showBackgroundModal()">
                ğŸ–¼ï¸ è®¾ç½®ç½‘é¡µèƒŒæ™¯
            </button>
            
            <button class="btn btn-success" onclick="showAddModuleModal()">
                â• æ·»åŠ æ–°æ¨¡å—
            </button>
            
            <button class="btn btn-secondary" onclick="showAddToolModal()">
                ğŸ”§ æ·»åŠ å·¥å…·
            </button>
            
            <button class="btn btn-secondary" onclick="showExportHelp()">
                ğŸ’¾ å¯¼å‡ºé…ç½®
            </button>
            
            <button class="btn btn-secondary" onclick="importConfig()">
                ğŸ“‚ å¯¼å…¥é…ç½®
            </button>

	    <!-- åœ¨æ§åˆ¶é¢æ¿çš„æŒ‰é’®åˆ—è¡¨ä¸­æ·»åŠ è¿™2ä¸ªæŒ‰é’® -->
    	    <button class="btn" onclick="showCloudStatus()" style="background: #f39c12;">
  		  ğŸ“Š æŸ¥çœ‹äº‘çŠ¶æ€
	    </button>

	    <button class="btn" onclick="startCloudSyncTest()" style="background: #9b59b6;">
   	    	 ğŸ§ª ä¸€é”®æµ‹è¯•äº‘åŒæ­¥
	    </button>
            
            <div class="mode-indicator" id="modeIndicator">
                ğŸ”’ æµè§ˆæ¨¡å¼
            </div>
        </div>
        
        <!-- æ¨¡å—å®¹å™¨ - æ”¹ä¸ºæ¨ªå‘æ’åˆ— -->
        <div class="modules-container" id="modulesContainer">
            <!-- æ¨¡å—ä¼šåœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
        </div>
    </div>
    
    <!-- =============== æ–°å¢çš„ç”¨æˆ·ç›¸å…³æ¨¡æ€æ¡† =============== -->
    
    <!-- ç”¨æˆ·æ³¨å†Œ/ç™»å½•æ¨¡æ€æ¡† -->
    <div class="modal" id="userAuthModal">
        <div class="user-modal-content">
            <div class="modal-header">
                <div class="modal-title">ğŸ‘¤ ç”¨æˆ·è´¦æˆ·</div>
                <button class="close-modal" onclick="closeUserAuthModal()">Ã—</button>
            </div>
            
            <div class="auth-tabs">
                <button class="auth-tab active" id="loginTab" onclick="switchAuthTab('login')">ç™»å½•</button>
                <button class="auth-tab" id="registerTab" onclick="switchAuthTab('register')">æ³¨å†Œ</button>
            </div>
            
            <!-- ç™»å½•è¡¨å• -->
            <div class="auth-form active" id="loginForm">
                <div class="form-group">
                    <label for="loginEmail">é‚®ç®±</label>
                    <input type="email" id="loginEmail" placeholder="è¯·è¾“å…¥æ‚¨çš„é‚®ç®±">
                </div>


                
<div class="form-group">
    <label for="loginPassword">å¯†ç </label>
    <div class="password-input-group">
        <input type="password" id="loginPassword" placeholder="è¯·è¾“å…¥å¯†ç ">
        <button type="button" class="toggle-password" onclick="togglePasswordVisibility('loginPassword', this)">ğŸ‘ï¸</button>
    </div>
</div>


<div class="form-group" style="display: flex; align-items: center; gap: 8px; margin-top: -10px; margin-bottom: 15px;">
    <input type="checkbox" id="rememberMe" checked style="width: auto; margin: 0;">
    <label for="rememberMe" style="margin: 0; font-size: 14px; color: #666;">è®°ä½æˆ‘çš„ç™»å½•ä¿¡æ¯</label>
</div>

                
                <div class="form-group" style="margin-top: 25px;">
                    <button class="btn" style="width: 100%;" onclick="loginUser()">
                        ç™»å½•
                    </button>
                </div>
                
<div class="form-footer">
    è¿˜æ²¡æœ‰è´¦æˆ·ï¼Ÿ <a onclick="switchAuthTab('register')">ç‚¹å‡»æ³¨å†Œ</a>
</div>

<!-- æ–°å¢ï¼šäº‘åŒæ­¥åŠŸèƒ½æç¤º -->
<div class="form-footer" style="margin-top: 15px; padding: 10px; background: rgba(52, 152, 219, 0.1); border-radius: 8px; border-left: 3px solid #3498db;">
    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
        <span style="color: #3498db;">â˜ï¸</span>
        <strong style="font-size: 13px;">äº‘åŒæ­¥åŠŸèƒ½</strong>
    </div>
    <div style="font-size: 12px; color: #555;">
        ç™»å½•åå¯äº«å—ï¼š<br>
        â€¢ äº‘ç«¯å¤‡ä»½ï¼Œæ•°æ®æ°¸ä¸ä¸¢å¤±<br>
        â€¢ å¤šè®¾å¤‡åŒæ­¥<br>
        â€¢ å¤´åƒäº‘å­˜å‚¨
    </div>
</div>
</div>
            
            <!-- æ³¨å†Œè¡¨å• -->
            <div class="auth-form" id="registerForm">
                <div class="avatar-upload-container">
                    <div class="avatar-preview" id="avatarPreview" onclick="document.getElementById('avatarUpload').click()">
                        <div class="avatar-placeholder">ğŸ‘¤</div>
                    </div>
                    <input type="file" id="avatarUpload" accept=".jpg,.jpeg,.png,.gif" style="display: none;" onchange="previewAvatar(event)">
                    <div class="avatar-upload-btn" onclick="document.getElementById('avatarUpload').click()">
                        ä¸Šä¼ å¤´åƒ
                    </div>
                    <small style="color: #7f8c8d; display: block; margin-top: 5px;">ç‚¹å‡»ä¸Šä¼ å¤´åƒï¼ˆå¯é€‰ï¼‰</small>
                </div>
                
                <div class="form-group">
                    <label for="registerName">ç”¨æˆ·å</label>
                    <input type="text" id="registerName" placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
                </div>
                
                <div class="form-group">
                    <label for="registerEmail">é‚®ç®±</label>
                    <input type="email" id="registerEmail" placeholder="è¯·è¾“å…¥é‚®ç®±">
                </div>
                
<div class="form-group">
    <label for="registerPassword">å¯†ç </label>
    <div class="password-input-group">
        <input type="password" id="registerPassword" placeholder="è¯·è¾“å…¥å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰">
        <button type="button" class="toggle-password" onclick="togglePasswordVisibility('registerPassword', this)">ğŸ‘ï¸</button>
    </div>
</div>                


<div class="form-group">
    <label for="registerConfirmPassword">ç¡®è®¤å¯†ç </label>
    <div class="password-input-group">
        <input type="password" id="registerConfirmPassword" placeholder="è¯·å†æ¬¡è¾“å…¥å¯†ç ">
        <button type="button" class="toggle-password" onclick="togglePasswordVisibility('registerConfirmPassword', this)">ğŸ‘ï¸</button>
    </div>
</div>
                
                <div class="form-group" style="margin-top: 25px;">
                    <button class="btn btn-success" style="width: 100%;" onclick="registerUser()">
                        æ³¨å†Œ
                    </button>
                </div>
                
                <div class="form-footer">
                    å·²æœ‰è´¦æˆ·ï¼Ÿ <a onclick="switchAuthTab('login')">ç‚¹å‡»ç™»å½•</a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ç¼–è¾‘å¤´åƒæ¨¡æ€æ¡† -->
    <div class="modal" id="avatarModal">
        <div class="user-modal-content" style="max-width: 350px;">
            <div class="modal-header">
                <div class="modal-title">ğŸ–¼ï¸ ç¼–è¾‘å¤´åƒ</div>
                <button class="close-modal" onclick="closeAvatarModal()">Ã—</button>
            </div>
            
            <div class="avatar-upload-container">
                <div class="avatar-preview" id="avatarEditPreview" onclick="document.getElementById('avatarEditUpload').click()">
                    <div class="avatar-placeholder">ğŸ‘¤</div>
                </div>
                <input type="file" id="avatarEditUpload" accept=".jpg,.jpeg,.png,.gif" style="display: none;" onchange="previewAvatarEdit(event)">
                
                <div style="display: flex; gap: 10px; justify-content: center; margin-top: 15px;">
                    <button class="avatar-upload-btn" onclick="document.getElementById('avatarEditUpload').click()">
                        é€‰æ‹©å›¾ç‰‡
                    </button>
                    <button class="avatar-upload-btn" style="background: #e74c3c;" onclick="removeAvatar()">
                        ç§»é™¤å¤´åƒ
                    </button>
                </div>
                
                <small style="color: #7f8c8d; display: block; margin-top: 10px; text-align: center;">
                    æ”¯æŒ JPGã€PNGã€GIF æ ¼å¼ï¼Œå»ºè®®å°ºå¯¸ 200x200 åƒç´ 
                </small>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 25px;">
                <button class="btn" onclick="saveAvatar()" style="flex: 2;">
                    ä¿å­˜å¤´åƒ
                </button>
                <button class="btn btn-secondary" onclick="closeAvatarModal()" style="flex: 1;">
                    å–æ¶ˆ
                </button>
            </div>
        </div>
    </div>



<!-- æ›´æ”¹å¯†ç æ¨¡æ€æ¡† -->
<div class="modal" id="changePasswordModal">
    <div class="user-modal-content" style="max-width: 400px;">
        <div class="modal-header">
            <div class="modal-title">ğŸ” æ›´æ”¹å¯†ç </div>
            <button class="close-modal" onclick="closeChangePasswordModal()">Ã—</button>
        </div>
        
        <div class="form-group">
            <label for="currentPassword">å½“å‰å¯†ç </label>
            <div class="password-input-group">
                <input type="password" id="currentPassword" placeholder="è¯·è¾“å…¥å½“å‰å¯†ç ">
                <button type="button" class="toggle-password" onclick="togglePasswordVisibility('currentPassword', this)">ğŸ‘ï¸</button>
            </div>
        </div>
        
        <div class="form-group">
            <label for="newPassword">æ–°å¯†ç </label>
            <div class="password-input-group">
                <input type="password" id="newPassword" placeholder="è¯·è¾“å…¥æ–°å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰">
                <button type="button" class="toggle-password" onclick="togglePasswordVisibility('newPassword', this)">ğŸ‘ï¸</button>
            </div>
            <small style="color: #7f8c8d; display: block; margin-top: 5px;">å¯†ç é•¿åº¦è‡³å°‘6ä½å­—ç¬¦</small>
        </div>
        
        <div class="form-group">
            <label for="confirmNewPassword">ç¡®è®¤æ–°å¯†ç </label>
            <div class="password-input-group">
                <input type="password" id="confirmNewPassword" placeholder="è¯·å†æ¬¡è¾“å…¥æ–°å¯†ç ">
                <button type="button" class="toggle-password" onclick="togglePasswordVisibility('confirmNewPassword', this)">ğŸ‘ï¸</button>
            </div>
        </div>
        
        <div id="passwordChangeMessage" style="margin: 15px 0; padding: 10px; border-radius: 5px; display: none;"></div>
        
        <div style="display: flex; gap: 10px; margin-top: 25px;">
            <button class="btn" onclick="changeUserPassword()" style="flex: 2;">
                ğŸ”’ æ›´æ”¹å¯†ç 
            </button>
            <button class="btn btn-secondary" onclick="closeChangePasswordModal()" style="flex: 1;">
                å–æ¶ˆ
            </button>
        </div>
    </div>
</div>


    
    <!-- =============== åŸæœ‰æ‰€æœ‰æ¨¡æ€æ¡† =============== -->
    
    <!-- å…³äºæœ¬ç«™æ¨¡æ€æ¡† -->
    <div class="modal" id="aboutModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">ğŸ“š å…³äºæœ¬ç«™</div>
                <button class="close-modal" onclick="closeAboutModal()">Ã—</button>
            </div>
            
            <div class="about-content">
                <div class="about-section">
                    <h3>ğŸŒŸ ç½‘ç«™ç®€ä»‹</h3>
                    <p>è¿™æ˜¯ä¸€ä¸ªå®Œå…¨è‡ªå®šä¹‰çš„æ™ºèƒ½å·¥å…·ç®±ï¼Œæ—¨åœ¨å¸®åŠ©ç”¨æˆ·é›†ä¸­ç®¡ç†å¸¸ç”¨çš„ç½‘ç«™å’Œåœ¨çº¿å·¥å…·ï¼Œæé«˜å·¥ä½œå’Œå­¦ä¹ æ•ˆç‡ã€‚</p>
                </div>
                
                <div class="about-section">
                    <h3>âœ¨ ç‰¹è‰²åŠŸèƒ½</h3>
                    <ul class="features-list">
                        <li>å®Œå…¨è‡ªå®šä¹‰çš„å·¥å…·ç®±å¸ƒå±€å’Œæ ·å¼</li>
                        <li>æ‹–æ‹½æ’åºæ¨¡å—å’Œå·¥å…·é¡¹</li>
                        <li>å¤šç§æ¨¡å—å¸ƒå±€é€‰æ‹©ï¼ˆç½‘æ ¼ã€åˆ—è¡¨ã€å¡ç‰‡ï¼‰</li>
                        <li>è‡ªå®šä¹‰èƒŒæ™¯å›¾ç‰‡å’Œé¢œè‰²</li>
                        <li>ç½‘é¡µæœç´¢å’Œç«™å†…æœç´¢åŠŸèƒ½</li>
                        <li>é…ç½®å¯¼å…¥å¯¼å‡º</li>
                        <li>å®æ—¶æ—¶é—´æ˜¾ç¤º</li>
                        <li>å“åº”å¼è®¾è®¡ï¼Œé€‚é…å„ç§è®¾å¤‡</li>
                        <li>å·¥å…·ç¼–è¾‘å’Œåˆ é™¤åŠŸèƒ½</li>
                        <li>æ¨¡å—èƒŒæ™¯è‡ªå®šä¹‰</li>
                        <li>ç”¨æˆ·æ³¨å†Œç™»å½•ç³»ç»Ÿ</li>
                        <li>äº‘å­˜å‚¨æ”¯æŒï¼ˆæ•°æ®æ°¸ä¸ä¸¢å¤±ï¼‰</li>
                        <li>ä¸ªæ€§åŒ–å¤´åƒè®¾ç½®</li>
                    </ul>
                </div>
                
                <div class="about-section">
                    <h3>ğŸ‘¨â€ğŸ’» ä½œè€…ä¿¡æ¯</h3>
                    <p>æœ¬å·¥å…·ç”±æ± å·å­¦é™¢æ•™å¸ˆåˆ˜æ€€åº†ï¼Œåˆ©ç”¨ AI åŠ©æ‰‹ååŠ©å¼€å‘ï¼Œè‡´åŠ›äºä¸ºç”¨æˆ·æä¾›ç®€æ´é«˜æ•ˆçš„å·¥å…·ç®¡ç†è§£å†³æ–¹æ¡ˆã€‚</p>
                    <p>ç‰ˆæœ¬ï¼šv5.0ï¼ˆäº‘å­˜å‚¨ç‰ˆï¼‰</p>
                    <p>æ›´æ–°æ—¥æœŸï¼š2026å¹´1æœˆ29æ—¥</p>
                </div>
                
                <div class="about-section">
                    <h3>ğŸ’¡ ä½¿ç”¨æç¤º</h3>
                    <p>1. è¿›å…¥ç¼–è¾‘æ¨¡å¼åï¼Œå¯ä»¥æ‹–æ‹½æ’åºæ¨¡å—å’Œå·¥å…·</p>
                    <p>2. å³é”®ç‚¹å‡»å·¥å…·å¯ä»¥å¿«é€Ÿç¼–è¾‘æˆ–åˆ é™¤</p>
                    <p>3. ä½¿ç”¨æœç´¢åŠŸèƒ½å¿«é€Ÿæ‰¾åˆ°éœ€è¦çš„å·¥å…·</p>
                    <p>4. æ³¨å†Œè´¦æˆ·å¯ä»¥ä¿å­˜ä¸ªæ€§åŒ–é…ç½®åˆ°äº‘ç«¯</p>
                    <p>5. åˆ‡æ¢æœç´¢å¼•æ“å’Œç«™å†…æœç´¢æ¨¡å¼</p>
                </div>
            </div>
            
            <button class="btn" style="width: 100%; margin-top: 20px;" onclick="closeAboutModal()">
                å…³é—­
            </button>
        </div>
    </div>
    
    <!-- å¯¼å‡ºé…ç½®æç¤ºæ¨¡æ€æ¡† -->
    <div class="modal" id="exportHelpModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">ğŸ’¾ å¯¼å‡ºé…ç½®è¯´æ˜</div>
                <button class="close-modal" onclick="closeExportHelpModal()">Ã—</button>
            </div>
            
            <div style="line-height: 1.7;">
                <p><strong>åŠŸèƒ½è¯´æ˜ï¼š</strong>å¯¼å‡ºå½“å‰å·¥å…·ç®±çš„æ‰€æœ‰é…ç½®åˆ°æœ¬åœ°æ–‡ä»¶ã€‚</p>
                
                <p><strong>å¯¼å‡ºçš„å†…å®¹åŒ…æ‹¬ï¼š</strong></p>
                <ul style="padding-left: 20px; margin-bottom: 20px;">
                    <li>ä»‹ç»æ çš„æ ‡é¢˜å’Œå†…å®¹</li>
                    <li>ä»‹ç»æ çš„èƒŒæ™¯è®¾ç½®</li>
                    <li>é¡µé¢èƒŒæ™¯å›¾ç‰‡/é¢œè‰²è®¾ç½®</li>
                    <li>æ‰€æœ‰æ¨¡å—çš„è®¾ç½®å’Œæ’åº</li>
                    <li>æ‰€æœ‰å·¥å…·çš„é…ç½®ä¿¡æ¯</li>
                </ul>
                
                <p><strong>ä½¿ç”¨åœºæ™¯ï¼š</strong></p>
                <ul style="padding-left: 20px; margin-bottom: 20px;">
                    <li>å¤‡ä»½å½“å‰é…ç½®ä»¥é˜²æ•°æ®ä¸¢å¤±</li>
                    <li>åœ¨å¤šå°è®¾å¤‡é—´åŒæ­¥é…ç½®</li>
                    <li>åˆ†äº«é…ç½®ç»™å…¶ä»–ç”¨æˆ·</li>
                    <li>å‡çº§å‰è¿›è¡Œæ•°æ®å¤‡ä»½</li>
                </ul>
                
                <p><strong>æ³¨æ„äº‹é¡¹ï¼š</strong></p>
                <ul style="padding-left: 20px; margin-bottom: 20px;">
                    <li>å¯¼å‡ºçš„æ–‡ä»¶æ˜¯JSONæ ¼å¼ï¼Œè¯·ä¸è¦æ‰‹åŠ¨ä¿®æ”¹</li>
                    <li>å»ºè®®å®šæœŸå¯¼å‡ºé…ç½®è¿›è¡Œå¤‡ä»½</li>
                    <li>å¯¼å…¥é…ç½®ä¼šè¦†ç›–å½“å‰æ‰€æœ‰è®¾ç½®ï¼Œè¯·è°¨æ…æ“ä½œ</li>
                </ul>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-success" onclick="confirmExport()" style="flex: 2;">
                    âœ… ç¡®è®¤å¯¼å‡ºé…ç½®
                </button>
                <button class="btn btn-secondary" onclick="closeExportHelpModal()" style="flex: 1;">
                    å–æ¶ˆ
                </button>
            </div>
        </div>
    </div>
    
    <!-- ç¼–è¾‘ä»‹ç»æ¨¡æ€æ¡† -->
    <div class="modal" id="introductionModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">ğŸ“ ç¼–è¾‘ä»‹ç»</div>
                <button class="close-modal" onclick="closeIntroductionModal()">Ã—</button>
            </div>
            
            <div class="form-group">
                <label for="introTitleInput">æ ‡é¢˜</label>
                <input type="text" id="introTitleInput" placeholder="è¯·è¾“å…¥ä»‹ç»æ ‡é¢˜">
            </div>
            
            <div class="form-group">
                <label for="introContentInput">å†…å®¹</label>
                <textarea id="introContentInput" rows="5" placeholder="è¯·è¾“å…¥ä»‹ç»å†…å®¹..."></textarea>
            </div>
            
            <button class="btn" style="width: 100%;" onclick="saveIntroduction()">
                ä¿å­˜æ›´æ”¹
            </button>
        </div>
    </div>
    
    <!-- ä»‹ç»æ èƒŒæ™¯è®¾ç½®æ¨¡æ€æ¡† -->
    <div class="modal" id="introductionBackgroundModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">ğŸ¨ è®¾ç½®ä»‹ç»æ èƒŒæ™¯</div>
                <button class="close-modal" onclick="closeIntroductionBackgroundModal()">Ã—</button>
            </div>
            
            <div class="form-group">
                <label for="introBgColor">èƒŒæ™¯é¢œè‰²</label>
                <input type="color" id="introBgColor" value="#667eea">
            </div>
            
            <div class="form-group">
                <label for="introBgOpacity">èƒŒæ™¯é€æ˜åº¦</label>
                <input type="range" id="introBgOpacity" min="0" max="100" value="90">
                <div style="display: flex; justify-content: space-between; font-size: 12px; color: #666;">
                    <span>é€æ˜</span>
                    <span id="introOpacityValue">90%</span>
                    <span>ä¸é€æ˜</span>
                </div>
                <small style="color: #7f8c8d;">è°ƒèŠ‚é€æ˜åº¦å¯ä»¥çœ‹åˆ°åé¢çš„é¡µé¢èƒŒæ™¯</small>
            </div>
            
            <div class="color-preview" id="introBgPreview" style="background: rgba(102, 126, 234, 0.9);"></div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn" onclick="saveIntroductionBackground()" style="flex: 1;">
                    åº”ç”¨èƒŒæ™¯
                </button>
                <button class="btn btn-secondary" onclick="resetIntroductionBackground()" style="flex: 1;">
                    é‡ç½®èƒŒæ™¯
                </button>
            </div>
        </div>
    </div>
    
    <!-- èƒŒæ™¯è®¾ç½®æ¨¡æ€æ¡† -->
    <div class="modal" id="backgroundModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">ğŸ–¼ï¸ è®¾ç½®é¡µé¢èƒŒæ™¯</div>
                <button class="close-modal" onclick="closeBackgroundModal()">Ã—</button>
            </div>
            
            <div class="bg-type-selector">
                <div class="bg-type-btn active" id="bgTypeImage" onclick="selectBgType('image')">
                    å›¾ç‰‡èƒŒæ™¯
                </div>
                <div class="bg-type-btn" id="bgTypeColor" onclick="selectBgType('color')">
                    çº¯è‰²èƒŒæ™¯
                </div>
            </div>
            
            <!-- å›¾ç‰‡èƒŒæ™¯è®¾ç½® -->
            <div id="imageBgSettings">
                <div class="form-group">
                    <label for="bgImageUrl">èƒŒæ™¯å›¾ç‰‡URLæˆ–ä¸Šä¼ æ–‡ä»¶</label>
                    <input type="url" id="bgImageUrl" placeholder="è¾“å…¥å›¾ç‰‡é“¾æ¥ï¼Œæˆ–ä¸Šä¼ æœ¬åœ°æ–‡ä»¶">
                    
                    <div class="file-upload-container">
                        <label class="file-upload-btn">
                            ğŸ“ é€‰æ‹©æœ¬åœ°å›¾ç‰‡
                            <input type="file" id="bgImageFile" accept=".jpg,.jpeg,.png,.gif,.tiff,.tif,.webp" style="display: none;" onchange="handleImageUpload(this)">
                        </label>
                        <div id="imageFileName" class="file-name"></div>
                        <small style="color: #7f8c8d;">æ”¯æŒ .jpg, .png, .gif, .tiff, .webp æ ¼å¼ï¼Œæœ€å¤§3MB</small>
                    </div>
                </div>
                
                <div class="bg-preview" id="bgPreview">
                    èƒŒæ™¯é¢„è§ˆ
                </div>
            </div>
            
            <!-- çº¯è‰²èƒŒæ™¯è®¾ç½® -->
            <div id="colorBgSettings" style="display: none;">
                <div class="form-group">
                    <label for="bgColorPicker">é€‰æ‹©èƒŒæ™¯é¢œè‰²</label>
                    <input type="color" id="bgColorPicker" value="#ffffff">
                </div>
                
                <div class="color-preview" id="colorPreview" style="background: #ffffff;"></div>
            </div>
            
            <div class="form-group">
                <label for="bgOverlay">èƒŒæ™¯é®ç½©é€æ˜åº¦</label>
                <input type="range" id="bgOverlay" min="0" max="100" value="15">
                <div style="display: flex; justify-content: space-between; font-size: 12px; color: #666;">
                    <span>é€æ˜</span>
                    <span id="overlayValue">15%</span>
                    <span>ä¸é€æ˜</span>
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn" onclick="saveBackground()" style="flex: 1;">
                    åº”ç”¨èƒŒæ™¯
                </button>
                <button class="btn btn-secondary" onclick="resetBackground()" style="flex: 1;">
                    é‡ç½®èƒŒæ™¯
                </button>
            </div>
        </div>
    </div>
    
    <!-- æ·»åŠ æ¨¡å—æ¨¡æ€æ¡† -->
    <div class="modal" id="addModuleModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">â• åˆ›å»ºæ–°æ¨¡å—</div>
                <button class="close-modal" onclick="closeAddModuleModal()">Ã—</button>
            </div>
            
            <div class="form-group">
                <label for="moduleName">æ¨¡å—åç§°</label>
                <input type="text" id="moduleName" placeholder="ä¾‹å¦‚ï¼šç§‘ç ”å·¥å…·ã€å¸¸ç”¨ç½‘ç«™">
            </div>
            
            <div class="form-group">
                <label for="moduleIcon">æ¨¡å—å›¾æ ‡</label>
                <select id="moduleIcon">
                    <option value="ğŸ”¬">ğŸ”¬ ç§‘ç ”</option>
                    <option value="ğŸŒ">ğŸŒ ç½‘ç»œ</option>
                    <option value="ğŸ“š">ğŸ“š å­¦æœ¯</option>
                    <option value="ğŸ’¼">ğŸ’¼ åŠå…¬</option>
                    <option value="ğŸ®">ğŸ® å¨±ä¹</option>
                    <option value="ğŸ› ï¸">ğŸ› ï¸ å·¥å…·</option>
                    <option value="ğŸ“Š">ğŸ“Š æ•°æ®</option>
                    <option value="ğŸ¨">ğŸ¨ è®¾è®¡</option>
                    <option value="ğŸ’»">ğŸ’» ç¼–ç¨‹</option>
                    <option value="ğŸ“±">ğŸ“± ç§»åŠ¨</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="moduleLayout">å¸ƒå±€æ ·å¼</label>
                <select id="moduleLayout">
                    <option value="grid-layout">ç½‘æ ¼å¸ƒå±€ï¼ˆé€‚åˆå¤§é‡å·¥å…·ï¼‰</option>
                    <option value="list-layout">åˆ—è¡¨å¸ƒå±€ï¼ˆé€‚åˆè¯¦ç»†å±•ç¤ºï¼‰</option>
                    <option value="card-layout">å¡ç‰‡å¸ƒå±€ï¼ˆç¾è§‚ç®€æ´ï¼‰</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="moduleColor">ä¸»é¢˜é¢œè‰²</label>
                <input type="color" id="moduleColor" value="#3498db">
            </div>
            
            <div class="form-group">
                <label for="moduleDescription">æ¨¡å—æè¿°ï¼ˆå¯é€‰ï¼‰</label>
                <textarea id="moduleDescription" rows="3" placeholder="ç®€è¦æè¿°è¿™ä¸ªæ¨¡å—çš„ç”¨é€”"></textarea>
            </div>
            
            <button class="btn btn-success" style="width: 100%; margin-top: 20px;" onclick="createNewModule()">
                åˆ›å»ºæ¨¡å—
            </button>
        </div>
    </div>
    
    <!-- æ·»åŠ /ç¼–è¾‘å·¥å…·æ¨¡æ€æ¡† -->
    <div class="modal" id="addToolModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="toolModalTitle">ğŸ”§ æ·»åŠ æ–°å·¥å…·</div>
                <button class="close-modal" onclick="closeAddToolModal()">Ã—</button>
            </div>
            
            <div class="form-group">
                <label for="targetModule">æ·»åŠ åˆ°å“ªä¸ªæ¨¡å—ï¼Ÿ</label>
                <select id="targetModule">
                    <!-- æ¨¡å—é€‰é¡¹ä¼šåŠ¨æ€ç”Ÿæˆ -->
                </select>
            </div>
            
            <div class="form-group">
                <label for="toolName">å·¥å…·åç§°</label>
                <input type="text" id="toolName" placeholder="ä¾‹å¦‚ï¼šGoogle Earth Engine">
            </div>
            
            <div class="form-group">
                <label for="toolUrl">å·¥å…·ç½‘å€</label>
                <input type="url" id="toolUrl" placeholder="https://example.com">
            </div>
            
            <div class="form-group">
                <label for="toolIcon">å·¥å…·å›¾æ ‡</label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="toolIcon" placeholder="è¾“å…¥Emojiï¼Œä¾‹å¦‚ï¼šğŸŒ" style="flex: 1;">
                    <label class="file-upload-btn" style="margin: 0;">
                        ğŸ“ ä¸Šä¼ å›¾æ ‡
                        <input type="file" id="toolIconFile" accept=".jpg,.jpeg,.png,.gif,.tiff,.tif,.webp" style="display: none;" onchange="handleToolIconUpload(this)">
                    </label>
                </div>
                <small style="color: #7f8c8d;">æç¤ºï¼šå¯ä»¥è¾“å…¥emojiè¡¨æƒ…æˆ–ä¸Šä¼ å›¾ç‰‡ï¼ˆæœ€å¤§1MBï¼‰</small>
                <div id="toolIconFileName" class="file-name"></div>
            </div>
            
            <div class="form-group">
                <label for="toolDescription">å·¥å…·æè¿°</label>
                <input type="text" id="toolDescription" placeholder="ç®€è¦æè¿°è¿™ä¸ªå·¥å…·çš„åŠŸèƒ½">
            </div>
            
            <input type="hidden" id="editingToolId" value="">
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-success" id="toolModalSubmitBtn" style="flex: 2;" onclick="saveTool()">
                    æ·»åŠ å·¥å…·
                </button>
                <button class="btn btn-secondary" onclick="closeAddToolModal()" style="flex: 1;">
                    å–æ¶ˆ
                </button>
            </div>
        </div>
    </div>
    
    <!-- ç¼–è¾‘æ¨¡å—æ¨¡æ€æ¡† -->
    <div class="modal" id="editModuleModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">âš™ï¸ ç¼–è¾‘æ¨¡å—</div>
                <button class="close-modal" onclick="closeEditModuleModal()">Ã—</button>
            </div>
            <div id="editModuleContent">
                <!-- ç¼–è¾‘å†…å®¹ä¼šåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
    </div>
    
    <script>
        // ==================== åŸæœ‰å…¨å±€å˜é‡ ====================
        let isEditMode = false;
        let currentModules = [];
        let currentDraggingModule = null;
        let currentDraggingTool = null;
        let currentEditingModuleId = null;
        let currentBgType = 'image';
        let uploadedBgImage = null;
        let uploadedToolIcon = null;
        let timeUpdateInterval = null;
        let editingTool = null;
        let searchTimeout = null;
        let currentSearchEngine = 'baidu';
        let isSiteSearchEnabled = false;
        
        // ==================== æ–°å¢äº‘å­˜å‚¨å˜é‡ ====================
        // ==================== åœ¨è¿™é‡Œæ›¿æ¢ä¸ºä½ çš„Supabaseé…ç½® ====================
        const SUPABASE_URL = 'https://zldpyrzatjiueghyzxda.supabase.co';  // æ›¿æ¢ä¸ºä½ çš„Supabase URL
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpsZHB5cnphdGppdWVnaHl6eGRhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk2NDc0OTQsImV4cCI6MjA4NTIyMzQ5NH0.uqVBQQqcokAc-fiqi-ZUPjKMF6KmaEhTFVZj2ps4A4s';                    // æ›¿æ¢ä¸ºä½ çš„Supabase anon key
        // ==================== æ›¿æ¢ç»“æŸ ====================
        
        let supabaseClient = null;
        let currentUser = null;
        let userAvatar = null;
        let newUserAvatar = null;
        let editingAvatar = null;
        let autoSaveInterval = null;
        
        // ==================== åŸæœ‰æœç´¢å¼•æ“é…ç½® ====================
        const searchEngines = {
            baidu: {
                name: 'ç™¾åº¦',
                url: 'https://www.baidu.com/s?wd=',
                icon: 'ğŸ”'
            },
            google: {
                name: 'Google',
                url: 'https://www.google.com/search?q=',
                icon: 'ğŸŒ'
            },
            bing: {
                name: 'Bing',
                url: 'https://www.bing.com/search?q=',
                icon: 'ğŸ¯'
            },
            zhihu: {
                name: 'çŸ¥ä¹',
                url: 'https://www.zhihu.com/search?type=content&q=',
                icon: 'ğŸ’¡'
            },
            github: {
                name: 'GitHub',
                url: 'https://github.com/search?q=',
                icon: 'ğŸ’»'
            }
        };
        
// ==================== æ–°å¢ï¼šå¯†ç æ˜¾ç¤º/éšè—åŠŸèƒ½ ====================
function togglePasswordVisibility(inputId, button) {
    const input = document.getElementById(inputId);
    if (input.type === 'password') {
        input.type = 'text';
        button.textContent = 'ğŸ™ˆ';
    } else {
        input.type = 'password';
        button.textContent = 'ğŸ‘ï¸';
    }
}

        // ==================== é¡µé¢åˆå§‹åŒ– ====================
        document.addEventListener('DOMContentLoaded', async function() {
            // åˆå§‹åŒ–Supabase
            initSupabase();
            
            // æ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€
            await checkUserLogin();
            
            // åŸæœ‰åˆå§‹åŒ–ä»£ç 
            loadIntroduction();
            loadIntroductionBackground();
            loadBackground();
            loadModules();
            
            renderModules();
            updateTargetModuleSelect();
            
            updateGlobalTime();
            timeUpdateInterval = setInterval(updateGlobalTime, 1000);
            
            document.getElementById('bgImageUrl').addEventListener('input', updateBgPreview);
            document.getElementById('bgOverlay').addEventListener('input', function() {
                document.getElementById('overlayValue').textContent = this.value + '%';
            });
            
            document.getElementById('introBgColor').addEventListener('input', updateIntroBgPreview);
            document.getElementById('introBgOpacity').addEventListener('input', function() {
                document.getElementById('introOpacityValue').textContent = this.value + '%';
                updateIntroBgPreview();
            });
            
            document.getElementById('bgColorPicker').addEventListener('input', function() {
                document.getElementById('colorPreview').style.background = this.value;
            });

// åˆå§‹åŒ–å¯†ç è¾“å…¥æ¡†çš„å°çœ¼ç›å›¾æ ‡
document.querySelectorAll('.password-input-group input[type="password"]').forEach(input => {
    const button = input.parentElement.querySelector('.toggle-password');
    if (button) {
        button.textContent = 'ğŸ‘ï¸';
    }
});            

            initModuleDragAndDrop();
            updateSearchHint();
        });
        
        // ==================== æ–°å¢ç”¨æˆ·ç³»ç»Ÿå‡½æ•° ====================
        
function initSupabase() {
    if (window.supabase && SUPABASE_URL && SUPABASE_ANON_KEY) {
        // ä½¿ç”¨çœŸå®çš„Supabaseå­˜å‚¨ï¼ˆç§»é™¤è™šæ‹Ÿå­˜å‚¨ï¼‰
        supabaseClient = window.supabase.createClient(
            SUPABASE_URL,
            SUPABASE_ANON_KEY
            // ä¸è¦ä¼ é€’storageå‚æ•°ï¼Œä½¿ç”¨é»˜è®¤é…ç½®
        );
        
        console.log('ğŸš€ Supabaseåˆå§‹åŒ–æˆåŠŸ');
        
        // æ£€æŸ¥å½“å‰ä¼šè¯
        supabaseClient.auth.getSession().then(({ data: { session } }) => {
            if (session) {
                console.log('æ£€æµ‹åˆ°å·²æœ‰ä¼šè¯ï¼Œç”¨æˆ·å·²ç™»å½•');
                // æ›´æ–°å½“å‰ç”¨æˆ·ä¿¡æ¯
                currentUser = {
                    id: session.user.id,
                    email: session.user.email,
                    name: session.user.user_metadata?.name || 'ç”¨æˆ·'
                };
                updateUserDisplay();
            }
        }).catch(error => {
            console.warn('ä¼šè¯æ£€æŸ¥å¤±è´¥:', error);
        });
        
    } else {
        console.warn('Supabaseé…ç½®ç¼ºå¤±ï¼Œä»…ä½¿ç”¨æœ¬åœ°æ¨¡å¼');
        renderLoginButton();
    }
}

// æ‰‹åŠ¨æ£€æŸ¥ç™»å½•çŠ¶æ€
async function checkLoginStatus() {
    const savedUser = localStorage.getItem('toolbox-current-user');
    if (savedUser) {
        try {
            currentUser = JSON.parse(savedUser);
            // å°è¯•è·å–sessionä½†ä¸ä¾èµ–localStorage
            const { data, error } = await supabaseClient.auth.getSession();
            if (error || !data.session) {
                // éœ€è¦é‡æ–°ç™»å½•
                currentUser = null;
                localStorage.removeItem('toolbox-current-user');
                renderLoginButton();
            } else {
                updateUserDisplay();
            }
        } catch (error) {
            currentUser = null;
            renderLoginButton();
        }
    } else {
        renderLoginButton();
    }
}


        
async function checkUserLogin() {
    // å¦‚æœæœ‰Supabaseå®¢æˆ·ç«¯ï¼Œæ£€æŸ¥ä¼šè¯
    if (supabaseClient) {
        try {
            const { data: { session }, error } = await supabaseClient.auth.getSession();
            
            if (error) {
                console.error('æ£€æŸ¥ä¼šè¯å¤±è´¥:', error);
                renderLoginButton();
                return;
            }
            
            if (session) {
                // ç”¨æˆ·å·²ç™»å½•
                currentUser = {
                    id: session.user.id,
                    email: session.user.email,
                    name: session.user.user_metadata?.name || 'ç”¨æˆ·'
                };
                
                // å°è¯•ä»æœ¬åœ°è·å–å¤´åƒ
                userAvatar = localStorage.getItem(`user-avatar-${currentUser.id}`);
                
                updateUserDisplay();
                await loadUserDataFromCloud();
                startAutoSave();
                return;
            }
        } catch (error) {
            console.error('ç”¨æˆ·ç™»å½•æ£€æŸ¥å¼‚å¸¸:', error);
        }
    }
    
    // æœªç™»å½•çŠ¶æ€
    renderLoginButton();
}




        




        
function renderLoginButton() {
    const userContainer = document.getElementById('userContainer');
    userContainer.classList.remove('logged-in');
    userContainer.innerHTML = `
        <div class="user-info">
            <div class="user-avatar" onclick="showUserAuthModal()">
                <span style="font-size: 20px;">ğŸ‘¤</span>
            </div>
            <div class="user-details">
                <div class="user-name">ç‚¹å‡»ç™»å½•</div>
                <div class="user-email">ä½¿ç”¨äº‘å­˜å‚¨åŠŸèƒ½</div>
            </div>
            <div class="user-actions">
                <!-- åªä¿ç•™ç™»å½•æŒ‰é’®ï¼Œç§»é™¤åŒæ­¥æŒ‰é’® -->
                <button class="user-btn" onclick="showUserAuthModal()">
                    ç™»å½•/æ³¨å†Œ
                </button>
            </div>
        </div>
    `;
}
        



// ==================== ç”¨æˆ·æ˜¾ç¤ºå’Œèœå•å‡½æ•° ====================

function updateUserDisplay() {
    const userContainer = document.getElementById('userContainer');
    if (!currentUser) {
        renderLoginButton();
        return;
    }
    
    userContainer.classList.add('logged-in');
    
    let avatarHTML = '';
    if (userAvatar) {
        avatarHTML = `<img src="${userAvatar}" alt="${currentUser.name}" style="width: 100%; height: 100%; object-fit: cover;">`;
    } else {
        const avatarLetter = currentUser.name ? currentUser.name.charAt(0).toUpperCase() : 'U';
        avatarHTML = `<span style="font-size: 20px;">${avatarLetter}</span>`;
    }
    
    userContainer.innerHTML = `
        <div class="user-info logged-in">
            <div class="user-avatar" onclick="toggleUserMenu()">
                ${avatarHTML}
            </div>
            <div class="user-details">
                <div class="user-name">${currentUser.name || 'ç”¨æˆ·'}</div>
                <div class="user-email">${currentUser.email || ''}</div>
            </div>
            <div class="user-actions">
                <button class="user-btn" onclick="manualCloudSync()" title="ç«‹å³åŒæ­¥åˆ°äº‘ç«¯">
                    ğŸ”„
                </button>
                <button class="user-btn user-btn-logout" onclick="logoutUser()" title="é€€å‡ºç™»å½•">
                    ğŸšª
                </button>
            </div>
        </div>
        
        <!-- ç”¨æˆ·èœå• - ç‚¹å‡»å¤´åƒåæ˜¾ç¤º -->
        <div class="user-menu" id="userMenu" style="display: none;">
            <div class="user-menu-header">
                <div class="user-menu-avatar">
                    ${avatarHTML}
                </div>
                <div class="user-menu-info">
                    <div class="user-menu-name">${currentUser.name}</div>
                    <div class="user-menu-email">${currentUser.email}</div>
                </div>
            </div>
            
            <div class="user-menu-items">
                <div class="user-menu-item" onclick="showChangePasswordModal()">
                    <span class="user-menu-icon">ğŸ”</span>
                    <span class="user-menu-text">æ›´æ”¹å¯†ç </span>
                </div>
                <div class="user-menu-item" onclick="showAvatarModal()">
                    <span class="user-menu-icon">ğŸ–¼ï¸</span>
                    <span class="user-menu-text">ä¿®æ”¹å¤´åƒ</span>
                </div>
                <div class="user-menu-item" onclick="manualCloudSync()">
                    <span class="user-menu-icon">ğŸ”„</span>
                    <span class="user-menu-text">ç«‹å³åŒæ­¥</span>
                </div>
                <div class="user-menu-item" onclick="logoutUser()" style="color: #e74c3c;">
                    <span class="user-menu-icon">ğŸšª</span>
                    <span class="user-menu-text">é€€å‡ºç™»å½•</span>
                </div>
            </div>
        </div>
    `;
}

// ==================== ç”¨æˆ·èœå•æ§åˆ¶å‡½æ•° ====================
let userMenuVisible = false;

function toggleUserMenu() {
    const userMenu = document.getElementById('userMenu');
    if (!userMenu) return;
    
    userMenuVisible = !userMenuVisible;
    
    if (userMenuVisible) {
        userMenu.style.display = 'block';
        
        // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­èœå•
        setTimeout(() => {
            document.addEventListener('click', closeUserMenuOutside);
        }, 10);
    } else {
        userMenu.style.display = 'none';
        document.removeEventListener('click', closeUserMenuOutside);
    }
}

function closeUserMenuOutside(event) {
    const userMenu = document.getElementById('userMenu');
    const userAvatar = document.querySelector('.user-avatar');
    
    if (userMenu && !userMenu.contains(event.target) && !userAvatar.contains(event.target)) {
        userMenu.style.display = 'none';
        userMenuVisible = false;
        document.removeEventListener('click', closeUserMenuOutside);
    }
}

// å…³é—­ç”¨æˆ·èœå•
function closeUserMenu() {
    const userMenu = document.getElementById('userMenu');
    if (userMenu) {
        userMenu.style.display = 'none';
        userMenuVisible = false;
        document.removeEventListener('click', closeUserMenuOutside);
    }
}

// ==================== æ›´æ”¹å¯†ç åŠŸèƒ½ ====================

// æ˜¾ç¤ºæ›´æ”¹å¯†ç æ¨¡æ€æ¡†
function showChangePasswordModal() {
    if (!currentUser) {
        alert('è¯·å…ˆç™»å½•');
        return;
    }
    
    // å…³é—­ç”¨æˆ·èœå•
    closeUserMenu();
    
    // æ¸…ç©ºè¡¨å•
    document.getElementById('currentPassword').value = '';
    document.getElementById('newPassword').value = '';
    document.getElementById('confirmNewPassword').value = '';
    document.getElementById('passwordChangeMessage').style.display = 'none';
    
    // é‡ç½®å¯†ç æ˜¾ç¤ºçŠ¶æ€
    document.getElementById('currentPassword').type = 'password';
    document.getElementById('newPassword').type = 'password';
    document.getElementById('confirmNewPassword').type = 'password';
    
    // æ˜¾ç¤ºæ¨¡æ€æ¡†
    document.getElementById('changePasswordModal').style.display = 'flex';
}

// å…³é—­æ›´æ”¹å¯†ç æ¨¡æ€æ¡†
function closeChangePasswordModal() {
    document.getElementById('changePasswordModal').style.display = 'none';
}

// æ›´æ”¹å¯†ç åŠŸèƒ½
async function changeUserPassword() {
    if (!currentUser || !supabaseClient) {
        alert('è¯·å…ˆç™»å½•');
        return;
    }
    
    const currentPassword = document.getElementById('currentPassword').value;
    const newPassword = document.getElementById('newPassword').value;
    const confirmNewPassword = document.getElementById('confirmNewPassword').value;
    
    // éªŒè¯è¾“å…¥
    if (!currentPassword || !newPassword || !confirmNewPassword) {
        showPasswordMessage('è¯·å¡«å†™æ‰€æœ‰å­—æ®µ', 'error');
        return;
    }
    
    if (newPassword.length < 6) {
        showPasswordMessage('æ–°å¯†ç è‡³å°‘éœ€è¦6ä½', 'error');
        return;
    }
    
    if (newPassword !== confirmNewPassword) {
        showPasswordMessage('ä¸¤æ¬¡è¾“å…¥çš„æ–°å¯†ç ä¸ä¸€è‡´', 'error');
        return;
    }
    
    try {
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        const submitBtn = document.querySelector('#changePasswordModal .btn');
        const originalText = submitBtn.textContent;
        submitBtn.textContent = 'æ­£åœ¨æ›´æ”¹...';
        submitBtn.disabled = true;
        
        // æ›´æ–°å¯†ç 
        const { data, error } = await supabaseClient.auth.updateUser({
            password: newPassword
        });
        
        if (error) {
            throw error;
        }
        
        // æˆåŠŸæç¤º
        showPasswordMessage('âœ… å¯†ç æ›´æ”¹æˆåŠŸï¼è¯·ä½¿ç”¨æ–°å¯†ç é‡æ–°ç™»å½•', 'success');
        
        // æ¸…ç©ºè¡¨å•
        document.getElementById('currentPassword').value = '';
        document.getElementById('newPassword').value = '';
        document.getElementById('confirmNewPassword').value = '';
        
        // 3ç§’åå…³é—­æ¨¡æ€æ¡†
        setTimeout(() => {
            closeChangePasswordModal();
            
            // è¯¢é—®æ˜¯å¦é‡æ–°ç™»å½•
            if (confirm('å¯†ç å·²æ›´æ”¹ï¼Œå»ºè®®é‡æ–°ç™»å½•ä»¥ç¡®ä¿å®‰å…¨ã€‚æ˜¯å¦ç«‹å³é‡æ–°ç™»å½•ï¼Ÿ')) {
                logoutUser();
                setTimeout(() => {
                    showUserAuthModal();
                }, 500);
            }
        }, 3000);
        
    } catch (error) {
        console.error('æ›´æ”¹å¯†ç é”™è¯¯:', error);
        
        // æ ¹æ®é”™è¯¯ç±»å‹æ˜¾ç¤ºå‹å¥½æç¤º
        let errorMessage = 'æ›´æ”¹å¯†ç å¤±è´¥ï¼š';
        
        if (error.message.includes('Auth session missing')) {
            errorMessage += 'ç™»å½•ä¼šè¯å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•';
        } else if (error.message.includes('New password should be different')) {
            errorMessage += 'æ–°å¯†ç ä¸èƒ½ä¸æ—§å¯†ç ç›¸åŒ';
        } else if (error.message.includes('Password should be at least')) {
            errorMessage += 'å¯†ç å¼ºåº¦ä¸è¶³ï¼Œè¯·ä½¿ç”¨æ›´å¤æ‚çš„å¯†ç ';
        } else {
            errorMessage += error.message;
        }
        
        showPasswordMessage(errorMessage, 'error');
        
    } finally {
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        const submitBtn = document.querySelector('#changePasswordModal .btn');
        if (submitBtn) {
            submitBtn.textContent = 'ğŸ”’ æ›´æ”¹å¯†ç ';
            submitBtn.disabled = false;
        }
    }
}

// æ˜¾ç¤ºå¯†ç æ›´æ”¹æ¶ˆæ¯
function showPasswordMessage(message, type) {
    const messageDiv = document.getElementById('passwordChangeMessage');
    messageDiv.textContent = message;
    messageDiv.style.display = 'block';
    
    if (type === 'success') {
        messageDiv.style.background = '#d4edda';
        messageDiv.style.color = '#155724';
        messageDiv.style.border = '1px solid #c3e6cb';
    } else {
        messageDiv.style.background = '#f8d7da';
        messageDiv.style.color = '#721c24';
        messageDiv.style.border = '1px solid #f5c6cb';
    }
}


        // ==================== å¤´åƒç®¡ç†å‡½æ•° ====================
        
        function previewAvatar(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
            if (!validTypes.includes(file.type)) {
                alert('è¯·ä¸Šä¼ æœ‰æ•ˆçš„å›¾ç‰‡æ–‡ä»¶ (æ”¯æŒæ ¼å¼: jpg, png, gif)');
                return;
            }
            
            const maxSize = 2 * 1024 * 1024;
            if (file.size > maxSize) {
                alert('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡2MB');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                newUserAvatar = e.target.result;
                document.getElementById('avatarPreview').innerHTML = `<img src="${newUserAvatar}" alt="å¤´åƒé¢„è§ˆ" style="width: 100%; height: 100%; object-fit: cover;">`;
            };
            reader.readAsDataURL(file);
        }
        
        function previewAvatarEdit(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
            if (!validTypes.includes(file.type)) {
                alert('è¯·ä¸Šä¼ æœ‰æ•ˆçš„å›¾ç‰‡æ–‡ä»¶ (æ”¯æŒæ ¼å¼: jpg, png, gif)');
                return;
            }
            
            const maxSize = 2 * 1024 * 1024;
            if (file.size > maxSize) {
                alert('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡2MB');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                editingAvatar = e.target.result;
                document.getElementById('avatarEditPreview').innerHTML = `<img src="${editingAvatar}" alt="å¤´åƒé¢„è§ˆ" style="width: 100%; height: 100%; object-fit: cover;">`;
            };
            reader.readAsDataURL(file);
        }
        
        function showAvatarModal() {
            if (!currentUser) return;
            
            editingAvatar = userAvatar;
            const preview = document.getElementById('avatarEditPreview');
            if (editingAvatar) {
                preview.innerHTML = `<img src="${editingAvatar}" alt="å½“å‰å¤´åƒ" style="width: 100%; height: 100%; object-fit: cover;">`;
            } else {
                const letter = currentUser.name ? currentUser.name.charAt(0).toUpperCase() : 'U';
                preview.innerHTML = `<span style="font-size: 36px;">${letter}</span>`;
            }
            document.getElementById('avatarModal').style.display = 'flex';
        }
        
        function closeAvatarModal() {
            document.getElementById('avatarModal').style.display = 'none';
            editingAvatar = null;
        }
        
        async function saveAvatar() {
            if (!currentUser) return;
            
            try {
                userAvatar = editingAvatar;
                
                if (userAvatar) {
                    localStorage.setItem(`user-avatar-${currentUser.id}`, userAvatar);
                } else {
                    localStorage.removeItem(`user-avatar-${currentUser.id}`);
                }
                
                updateUserDisplay();
                closeAvatarModal();
                
                alert('å¤´åƒå·²ä¿å­˜ï¼');
                
            } catch (error) {
                console.error('ä¿å­˜å¤´åƒé”™è¯¯:', error);
                alert('ä¿å­˜å¤´åƒå¤±è´¥ï¼š' + error.message);
            }
        }
        
        function removeAvatar() {
            editingAvatar = null;
            const letter = currentUser.name ? currentUser.name.charAt(0).toUpperCase() : 'U';
            document.getElementById('avatarEditPreview').innerHTML = 
                `<span style="font-size: 36px;">${letter}</span>`;
        }
        
        // ==================== æ³¨å†Œç™»å½•å‡½æ•° ====================
        
async function registerUser() {
    if (!supabaseClient) {
        alert('äº‘æœåŠ¡æœªé…ç½®ï¼Œæ— æ³•æ³¨å†Œ');
        return;
    }
    
    const name = document.getElementById('registerName').value.trim();
    const email = document.getElementById('registerEmail').value.trim();
    const password = document.getElementById('registerPassword').value;
    const confirmPassword = document.getElementById('registerConfirmPassword').value;
    
    // éªŒè¯è¾“å…¥
    if (!name || !email || !password || !confirmPassword) {
        alert('è¯·å¡«å†™æ‰€æœ‰å­—æ®µ');
        return;
    }
    
    if (password.length < 6) {
        alert('å¯†ç è‡³å°‘éœ€è¦6ä½');
        return;
    }
    
    if (password !== confirmPassword) {
        alert('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´');
        return;
    }
    
    if (!validateEmail(email)) {
        alert('è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€');
        return;
    }
    
    try {
        console.log('å¼€å§‹æ³¨å†Œç”¨æˆ·...');
        
        // 1. æ³¨å†Œç”¨æˆ·
        const { data: authData, error: authError } = await supabaseClient.auth.signUp({
            email: email,
            password: password,
            options: {
                data: { 
                    name: name,
                    // æš‚æ—¶ä¸è®¾ç½®å¤´åƒï¼Œç­‰ç”¨æˆ·ç¡®è®¤é‚®ç®±åå†ä¸Šä¼ 
                }
            }
        });
        
        if (authError) {
            console.error('æ³¨å†Œé”™è¯¯:', authError);
            
            // æ›´å‹å¥½çš„é”™è¯¯æç¤º
            if (authError.message.includes('already registered')) {
                throw new Error('è¯¥é‚®ç®±å·²æ³¨å†Œï¼Œè¯·ç›´æ¥ç™»å½•');
            } else if (authError.message.includes('weak password')) {
                throw new Error('å¯†ç å¼ºåº¦ä¸è¶³ï¼Œè¯·ä½¿ç”¨æ›´å¤æ‚çš„å¯†ç ');
            } else {
                throw authError;
            }
        }
        
        console.log('ç”¨æˆ·æ³¨å†ŒæˆåŠŸï¼Œç”¨æˆ·ID:', authData.user?.id);
        
        if (!authData.user) {
            throw new Error('ç”¨æˆ·åˆ›å»ºå¤±è´¥ï¼Œæœªè¿”å›ç”¨æˆ·ä¿¡æ¯');
        }
        
        // 2. å¦‚æœæœ‰å¤´åƒï¼Œä¸Šä¼ åˆ°äº‘ç«¯
        if (newUserAvatar) {
            try {
                await uploadAvatarToCloud(authData.user.id, newUserAvatar);
            } catch (avatarError) {
                console.warn('å¤´åƒä¸Šä¼ å¤±è´¥ï¼ˆå¯ç»§ç»­ï¼‰:', avatarError);
                // å¤´åƒä¸Šä¼ å¤±è´¥ä¸å½±å“æ³¨å†Œ
            }
        }
        
        // 3. ä¿å­˜åˆå§‹é…ç½®åˆ°äº‘ç«¯
        const initialConfig = getDefaultCloudConfig();
        
        // ç­‰å¾…ä¸€ä¼šå„¿ç¡®ä¿ç”¨æˆ·åˆ›å»ºå®Œæˆ
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        try {
            const { error: configError } = await supabaseClient
                .from('user_configs')
                .upsert({
                    user_id: authData.user.id,
                    config_data: initialConfig,
                    last_updated: new Date().toISOString()
                }, {
                    onConflict: 'user_id'
                });
            
            if (configError) {
                console.warn('åˆå§‹é…ç½®ä¿å­˜è­¦å‘Š:', configError);
                // ä¸æŠ›å‡ºé”™è¯¯ï¼Œè®©ç”¨æˆ·ç»§ç»­
            }
        } catch (configError) {
            console.warn('åˆå§‹é…ç½®ä¿å­˜å¼‚å¸¸:', configError);
        }
        
        // 4. æ˜¾ç¤ºæˆåŠŸä¿¡æ¯
        closeUserAuthModal();
        
        // æ£€æŸ¥æ˜¯å¦éœ€è¦é‚®ç®±éªŒè¯
        if (authData.user && authData.user.identities && authData.user.identities.length === 0) {
            alert(`ğŸ‰ æ³¨å†ŒæˆåŠŸï¼\nè¯·æ£€æŸ¥æ‚¨çš„é‚®ç®± ${email} å¹¶ç‚¹å‡»éªŒè¯é“¾æ¥ã€‚\néªŒè¯åå³å¯ç™»å½•ä½¿ç”¨ã€‚`);
        } else {
            alert(`ğŸ‰ æ³¨å†ŒæˆåŠŸï¼\næ¬¢è¿ ${name}ï¼\næ‚¨çš„è´¦æˆ·å·²åˆ›å»ºï¼Œè¯·ä½¿ç”¨æ‚¨çš„é‚®ç®±å’Œå¯†ç ç™»å½•ã€‚`);
        }
        
        // 5. æ¸…ç©ºè¡¨å•
        document.getElementById('registerName').value = '';
        document.getElementById('registerEmail').value = '';
        document.getElementById('registerPassword').value = '';
        document.getElementById('registerConfirmPassword').value = '';
        document.getElementById('avatarPreview').innerHTML = '<div class="avatar-placeholder">ğŸ‘¤</div>';
        newUserAvatar = null;
        
        // 6. åˆ‡æ¢åˆ°ç™»å½•æ ‡ç­¾
        switchAuthTab('login');
        
    } catch (error) {
        console.error('æ³¨å†Œè¿‡ç¨‹é”™è¯¯:', error);
        alert('æ³¨å†Œå¤±è´¥ï¼š' + error.message);
    }
}





// ==================== å¤´åƒäº‘ç«¯å­˜å‚¨å‡½æ•° ====================

async function uploadAvatarToCloud(userId, avatarDataUrl) {
    if (!supabaseClient || !userId || !avatarDataUrl) return null;
    
    try {
        // 1. å°†Data URLè½¬æ¢ä¸ºBlob
        const response = await fetch(avatarDataUrl);
        const blob = await response.blob();
        
        // 2. ç”Ÿæˆæ–‡ä»¶å
        const fileExt = avatarDataUrl.split(';')[0].split('/')[1];
        const fileName = `${userId}/avatar.${fileExt}`;
        
        // 3. ä¸Šä¼ åˆ°Supabase Storage
        const { data, error } = await supabaseClient
            .storage
            .from('user-avatars')
            .upload(fileName, blob, {
                upsert: true, // å¦‚æœå­˜åœ¨åˆ™è¦†ç›–
                contentType: blob.type
            });
        
        if (error) throw error;
        
        // 4. è·å–å…¬å¼€URL
        const { data: { publicUrl } } = supabaseClient
            .storage
            .from('user-avatars')
            .getPublicUrl(fileName);
        
        console.log('å¤´åƒä¸Šä¼ æˆåŠŸ:', publicUrl);
        return publicUrl;
        
    } catch (error) {
        console.error('å¤´åƒä¸Šä¼ å¤±è´¥:', error);
        throw error;
    }
}

async function getAvatarFromCloud(userId) {
    if (!supabaseClient || !userId) return null;
    
    try {
        // å°è¯•è·å–å¤´åƒ
        const { data: files, error } = await supabaseClient
            .storage
            .from('user-avatars')
            .list(userId);
        
        if (error) {
            console.warn('è·å–å¤´åƒåˆ—è¡¨å¤±è´¥:', error);
            return null;
        }
        
        if (files && files.length > 0) {
            // è·å–ç¬¬ä¸€ä¸ªæ–‡ä»¶ï¼ˆåº”è¯¥æ˜¯avatar.*ï¼‰
            const fileName = `${userId}/${files[0].name}`;
            const { data: { publicUrl } } = supabaseClient
                .storage
                .from('user-avatars')
                .getPublicUrl(fileName);
            
            return publicUrl;
        }
        
        return null;
    } catch (error) {
        console.error('è·å–äº‘ç«¯å¤´åƒå¤±è´¥:', error);
        return null;
    }
}













        async function loginUser() {
            if (!supabaseClient) {
                alert('äº‘æœåŠ¡æœªé…ç½®ï¼Œæ— æ³•ç™»å½•');
                return;
            }
            
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                alert('è¯·è¾“å…¥é‚®ç®±å’Œå¯†ç ');
                return;
            }
            
            try {
                // ç™»å½•ç”¨æˆ·
                const { data: authData, error: authError } = await supabaseClient.auth.signInWithPassword({
                    email: email,
                    password: password
                });
                
                if (authError) throw authError;
                
                // è·å–æœ¬åœ°å­˜å‚¨çš„å¤´åƒ
                const cachedAvatar = localStorage.getItem(`user-avatar-${authData.user.id}`);
                
                // ä»äº‘ç«¯è·å–ç”¨æˆ·é…ç½®
                const { data: configData, error: configError } = await supabaseClient
                    .from('user_configs')
                    .select('config_data')
                    .eq('user_id', authData.user.id)
                    .maybeSingle();
                
                // æ›´æ–°å½“å‰ç”¨æˆ·ä¿¡æ¯
                currentUser = {
                    id: authData.user.id,
                    name: authData.user.user_metadata?.name || 'ç”¨æˆ·',
                    email: authData.user.email
                };
                
                userAvatar = cachedAvatar;
                localStorage.setItem('toolbox-current-user', JSON.stringify(currentUser));
// æ ¹æ®"è®°ä½æˆ‘"å¤é€‰æ¡†ä¿å­˜ç™»å½•ä¿¡æ¯
const rememberMe = document.getElementById('rememberMe');
if (rememberMe && rememberMe.checked) {
    // åªä¿å­˜é‚®ç®±ï¼Œä¸ä¿å­˜å¯†ç ï¼
    localStorage.setItem('toolbox-login-email', email);
    // ä¸è¦ä¿å­˜å¯†ç åˆ°æœ¬åœ°ï¼
} else {
    localStorage.removeItem('toolbox-login-email');
    // ç¡®ä¿å¯†ç ä¹Ÿè¢«æ¸…é™¤
    localStorage.removeItem('toolbox-login-password');
}
                
                // åŠ è½½äº‘ç«¯é…ç½®
                if (configData && configData.config_data) {
                    await loadCloudConfig(configData.config_data);
                } else {
                    // å¦‚æœæ²¡æœ‰é…ç½®ï¼Œåˆ›å»ºé»˜è®¤é…ç½®
                    const initialConfig = getDefaultCloudConfig();
                    await supabaseClient
                        .from('user_configs')
                        .insert([
                            {
                                user_id: authData.user.id,
                                config_data: initialConfig,
                                last_updated: new Date().toISOString()
                            }
                        ]);
                    await loadCloudConfig(initialConfig);
                }
                
                // æ›´æ–°UI
                updateUserDisplay();
                closeUserAuthModal();
                
                // å¼€å§‹è‡ªåŠ¨ä¿å­˜
                startAutoSave();
                
                alert(`ğŸ‘‹ æ¬¢è¿å›æ¥ï¼Œ${currentUser.name}ï¼`);
                
            } catch (error) {
                console.error('ç™»å½•é”™è¯¯:', error);
                alert('ç™»å½•å¤±è´¥ï¼š' + error.message);
            }
        }
        
        async function logoutUser() {
            if (!confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) return;
            
            try {
	        // å…³é—­ç”¨æˆ·èœå•
        	closeUserMenu();

                // å¦‚æœæœ‰ç”¨æˆ·ç™»å½•ï¼Œä¿å­˜å½“å‰é…ç½®
                if (currentUser && supabaseClient) {
                    await saveToCloud();
                    await supabaseClient.auth.signOut();
                }
                
                // æ¸…é™¤ç”¨æˆ·ä¿¡æ¯
                currentUser = null;
                userAvatar = null;
                localStorage.removeItem('toolbox-current-user');
		localStorage.removeItem('toolbox-login-password'); // æ¸…é™¤ä¿å­˜çš„å¯†ç 
                
                // é‡æ–°åŠ è½½æœ¬åœ°æ•°æ®
                loadModulesFromLocal();
                updateUserDisplay();
                renderModules();
                
                // åœæ­¢è‡ªåŠ¨ä¿å­˜
                stopAutoSave();
                
                alert('å·²é€€å‡ºç™»å½•');
                
            } catch (error) {
                console.error('é€€å‡ºé”™è¯¯:', error);
                alert('é€€å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }
        
        // ==================== äº‘å­˜å‚¨å‡½æ•° ====================
        
async function loadUserDataFromCloud() {
    if (!currentUser || !supabaseClient) return;
    
    try {
        console.log('æ­£åœ¨ä»äº‘ç«¯åŠ è½½ç”¨æˆ·æ•°æ®...');
        
        // 1. åŠ è½½é…ç½®æ•°æ®
        const { data: configData, error: configError } = await supabaseClient
            .from('user_configs')
            .select('config_data')
            .eq('user_id', currentUser.id)
            .maybeSingle();
        
        if (configError) {
            console.error('åŠ è½½é…ç½®æ•°æ®é”™è¯¯:', configError);
            // ä¸æŠ›å‡ºé”™è¯¯ï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®
            return;
        }
        
        // 2. åŠ è½½äº‘ç«¯å¤´åƒ
        try {
            const cloudAvatar = await getAvatarFromCloud(currentUser.id);
            if (cloudAvatar) {
                userAvatar = cloudAvatar;
                localStorage.setItem(`user-avatar-${currentUser.id}`, cloudAvatar);
            }
        } catch (avatarError) {
            console.warn('åŠ è½½äº‘ç«¯å¤´åƒå¤±è´¥:', avatarError);
            // ä½¿ç”¨æœ¬åœ°å¤´åƒ
            userAvatar = localStorage.getItem(`user-avatar-${currentUser.id}`);
        }
        
        // 3. åº”ç”¨é…ç½®æ•°æ®
        if (configData && configData.config_data) {
            await loadCloudConfig(configData.config_data);
        } else {
            console.log('äº‘ç«¯æ— é…ç½®æ•°æ®ï¼Œä½¿ç”¨é»˜è®¤é…ç½®');
            // å¦‚æœæ²¡æœ‰é…ç½®ï¼Œåˆ›å»ºé»˜è®¤é…ç½®
            const initialConfig = getDefaultCloudConfig();
            await saveToCloud(); // ä¿å­˜é»˜è®¤é…ç½®åˆ°äº‘ç«¯
        }
        
        // 4. æ›´æ–°ç”¨æˆ·æ˜¾ç¤ºï¼ˆåŒ…å«å¤´åƒï¼‰
        updateUserDisplay();
        
        console.log('äº‘ç«¯æ•°æ®åŠ è½½å®Œæˆ');
        
    } catch (error) {
        console.error('åŠ è½½äº‘æ•°æ®é”™è¯¯:', error);
        // åŠ è½½å¤±è´¥æ—¶ä½¿ç”¨æœ¬åœ°æ•°æ®
        loadModulesFromLocal();
    }
}





        
        async function loadCloudConfig(config) {
            try {
                if (config.introduction) {
                    document.getElementById('introTitle').textContent = config.introduction.title;
                    document.getElementById('introContent').textContent = config.introduction.content;
                    localStorage.setItem('toolbox-intro-title', config.introduction.title);
                    localStorage.setItem('toolbox-intro-content', config.introduction.content);
                }
                
                if (config.introBackground) {
                    localStorage.setItem('toolbox-intro-bg-color', config.introBackground.color);
                    localStorage.setItem('toolbox-intro-bg-opacity', config.introBackground.opacity);
                }
                
                if (config.background) {
                    localStorage.setItem('toolbox-bg-type', config.background.type);
                    if (config.background.image) {
                        localStorage.setItem('toolbox-bg-image', config.background.image);
                    }
                    if (config.background.color) {
                        localStorage.setItem('toolbox-bg-color', config.background.color);
                    }
                    localStorage.setItem('toolbox-bg-overlay', config.background.overlay);
                }
                
                if (config.modules) {
                    currentModules = config.modules;
                    localStorage.setItem('toolbox-modules', JSON.stringify(currentModules));
                }
                
                // é‡æ–°åŠ è½½é¡µé¢æ˜¾ç¤º
                loadIntroduction();
                loadIntroductionBackground();
                loadBackground();
                renderModules();
                
            } catch (error) {
                console.error('åŠ è½½é…ç½®é”™è¯¯:', error);
            }
        }
        




async function saveToCloud() {
    if (!currentUser || !supabaseClient) {
        console.log('æœªç™»å½•æˆ–æ— Supabaseå®¢æˆ·ç«¯ï¼Œè·³è¿‡äº‘ç«¯ä¿å­˜');
        return;
    }
    
    try {
        console.log('æ­£åœ¨ä¿å­˜åˆ°äº‘ç«¯...');
        
        const config = {
            introduction: {
                title: document.getElementById('introTitle').textContent,
                content: document.getElementById('introContent').textContent
            },
            introBackground: {
                color: localStorage.getItem('toolbox-intro-bg-color') || '#667eea',
                opacity: localStorage.getItem('toolbox-intro-bg-opacity') || '90'
            },
            background: {
                type: localStorage.getItem('toolbox-bg-type') || 'image',
                image: localStorage.getItem('toolbox-bg-image') || '',
                color: localStorage.getItem('toolbox-bg-color') || '#ffffff',
                overlay: localStorage.getItem('toolbox-bg-overlay') || '15'
            },
            modules: currentModules,
            last_saved: new Date().toISOString()
        };
        
        // ä½¿ç”¨ upsert æ›´æ–°æˆ–æ’å…¥
        const { error } = await supabaseClient
            .from('user_configs')
            .upsert({
                user_id: currentUser.id,
                config_data: config,
                last_updated: new Date().toISOString()
            }, {
                onConflict: 'user_id'
            });
        
        if (error) {
            console.error('âŒ äº‘ç«¯ä¿å­˜å¤±è´¥ï¼š', error);
            // è¿™é‡Œå¯ä»¥æ·»åŠ é‡è¯•é€»è¾‘æˆ–ç”¨æˆ·æç¤º
        } else {
            console.log('âœ… é…ç½®å·²åŒæ­¥åˆ°äº‘ç«¯');
        }
        
    } catch (error) {
        console.error('ä¿å­˜åˆ°äº‘ç«¯å¼‚å¸¸ï¼š', error);
        // å¼‚å¸¸å¤„ç†ï¼šå¯ä»¥é™çº§åˆ°æœ¬åœ°ä¿å­˜
    }
}










// ==================== äº‘åŒæ­¥æµ‹è¯•åŠŸèƒ½ ====================

// 1. æŸ¥çœ‹äº‘çŠ¶æ€
async function showCloudStatus() {
    // åˆ›å»ºçŠ¶æ€æ˜¾ç¤ºé¢æ¿
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
    `;
    
    modal.innerHTML = `
        <div style="
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        ">
            <h2 style="margin-bottom: 20px; color: #2c3e50;">ğŸ“Š äº‘åŒæ­¥çŠ¶æ€æ£€æµ‹</h2>
            
            <div id="statusContent" style="line-height: 1.6;">
                <p>æ­£åœ¨æ£€æµ‹äº‘åŒæ­¥çŠ¶æ€...</p>
            </div>
            
            <div style="margin-top: 25px; text-align: center;">
                <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                        style="padding: 10px 20px; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer;">
                    å…³é—­
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // å¼€å§‹æ£€æµ‹
    await checkCloudStatus();
}

// 2. æ£€æµ‹çŠ¶æ€çš„å…·ä½“é€»è¾‘
async function checkCloudStatus() {
    const statusContent = document.getElementById('statusContent');
    
    // æ­¥éª¤1ï¼šæ£€æŸ¥ç™»å½•çŠ¶æ€
    statusContent.innerHTML = '<p>ğŸ” æ£€æŸ¥ç™»å½•çŠ¶æ€...</p>';
    
    if (!currentUser) {
        statusContent.innerHTML += `
            <div style="background: #ffeaa7; padding: 10px; border-radius: 5px; margin: 10px 0;">
                <strong>âŒ æœªç™»å½•</strong><br>
                <small>è¯·å…ˆç™»å½•æ‰èƒ½ä½¿ç”¨äº‘åŒæ­¥åŠŸèƒ½</small>
            </div>
        `;
        return;
    }
    
    statusContent.innerHTML += `
        <div style="background: #d4edda; padding: 10px; border-radius: 5px; margin: 10px 0;">
            <strong>âœ… å·²ç™»å½•</strong><br>
            <small>ç”¨æˆ·: ${currentUser.email}</small>
        </div>
    `;
    
    // æ­¥éª¤2ï¼šæ£€æŸ¥Supabaseè¿æ¥
    statusContent.innerHTML += '<p>ğŸ” æ£€æŸ¥äº‘ç«¯è¿æ¥...</p>';
    
    if (!supabaseClient) {
        statusContent.innerHTML += `
            <div style="background: #f8d7da; padding: 10px; border-radius: 5px; margin: 10px 0;">
                <strong>âŒ Supabaseæœªè¿æ¥</strong><br>
                <small>è¯·è”ç³»ç®¡ç†å‘˜æ£€æŸ¥é…ç½®</small>
            </div>
        `;
        return;
    }
    
    statusContent.innerHTML += `
        <div style="background: #d4edda; padding: 10px; border-radius: 5px; margin: 10px 0;">
            <strong>âœ… äº‘ç«¯è¿æ¥æ­£å¸¸</strong>
        </div>
    `;
    
    // æ­¥éª¤3ï¼šæ£€æŸ¥æœ¬åœ°æ•°æ®
    statusContent.innerHTML += '<p>ğŸ” æ£€æŸ¥æœ¬åœ°æ•°æ®...</p>';
    
    const localModules = JSON.parse(localStorage.getItem('toolbox-modules') || '[]');
    const moduleCount = localModules.length;
    let toolCount = 0;
    localModules.forEach(module => {
        toolCount += (module.tools || []).length;
    });
    
    statusContent.innerHTML += `
        <div style="background: #e7f3ff; padding: 10px; border-radius: 5px; margin: 10px 0;">
            <strong>ğŸ“¦ æœ¬åœ°æ•°æ®ç»Ÿè®¡</strong><br>
            æ¨¡å—æ•°: ${moduleCount}<br>
            å·¥å…·æ€»æ•°: ${toolCount}
        </div>
    `;
    
    // æ­¥éª¤4ï¼šæ£€æŸ¥äº‘ç«¯æ•°æ®
    statusContent.innerHTML += '<p>ğŸ” æ£€æŸ¥äº‘ç«¯æ•°æ®...</p>';
    
    try {
        const { data, error } = await supabaseClient
            .from('user_configs')
            .select('last_updated, config_data')
            .eq('user_id', currentUser.id)
            .maybeSingle();
        
        if (error) {
            statusContent.innerHTML += `
                <div style="background: #f8d7da; padding: 10px; border-radius: 5px; margin: 10px 0;">
                    <strong>âŒ äº‘ç«¯æŸ¥è¯¢å¤±è´¥</strong><br>
                    <small>é”™è¯¯: ${error.message}</small>
                </div>
            `;
            
            if (error.message.includes('does not exist')) {
                statusContent.innerHTML += `
                    <div style="background: #fff3cd; padding: 10px; border-radius: 5px; margin: 10px 0;">
                        <strong>âš ï¸ æ•°æ®åº“è¡¨ä¸å­˜åœ¨</strong><br>
                        <small>éœ€è¦åœ¨Supabaseä¸­åˆ›å»ºuser_configsè¡¨</small>
                    </div>
                `;
            }
        } else if (data) {
            const cloudToolCount = data.config_data.modules?.reduce((sum, m) => sum + (m.tools?.length || 0), 0) || 0;
            
            statusContent.innerHTML += `
                <div style="background: #d4edda; padding: 10px; border-radius: 5px; margin: 10px 0;">
                    <strong>âœ… äº‘ç«¯æ•°æ®å­˜åœ¨</strong><br>
                    æœ€ååŒæ­¥: ${new Date(data.last_updated).toLocaleString()}<br>
                    äº‘ç«¯å·¥å…·æ•°: ${cloudToolCount}
                </div>
            `;
            
            // æ¯”è¾ƒæœ¬åœ°å’Œäº‘ç«¯
            if (toolCount !== cloudToolCount) {
                statusContent.innerHTML += `
                    <div style="background: #fff3cd; padding: 10px; border-radius: 5px; margin: 10px 0;">
                        <strong>âš ï¸ æ•°æ®ä¸ä¸€è‡´</strong><br>
                        <small>æœ¬åœ°: ${toolCount}ä¸ªå·¥å…· | äº‘ç«¯: ${cloudToolCount}ä¸ªå·¥å…·</small>
                    </div>
                `;
            }
        } else {
            statusContent.innerHTML += `
                <div style="background: #fff3cd; padding: 10px; border-radius: 5px; margin: 10px 0;">
                    <strong>âš ï¸ äº‘ç«¯æ— æ•°æ®</strong><br>
                    <small>è¯·ç‚¹å‡»"ç«‹å³åŒæ­¥"æŒ‰é’®ä¸Šä¼ æ•°æ®</small>
                </div>
            `;
        }
    } catch (error) {
        statusContent.innerHTML += `
            <div style="background: #f8d7da; padding: 10px; border-radius: 5px; margin: 10px 0;">
                <strong>âŒ äº‘ç«¯æ£€æŸ¥å¼‚å¸¸</strong><br>
                <small>${error.message}</small>
            </div>
        `;
    }
    
    // æ­¥éª¤5ï¼šæ·»åŠ æ“ä½œæŒ‰é’®
    statusContent.innerHTML += `
        <div style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
            <button onclick="forceSaveToCloudTest()" 
                    style="padding: 10px 15px; background: #27ae60; color: white; border: none; border-radius: 5px; cursor: pointer; flex: 1;">
                ğŸ’¾ ç«‹å³åŒæ­¥åˆ°äº‘ç«¯
            </button>
            <button onclick="loadFromCloudTest()" 
                    style="padding: 10px 15px; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer; flex: 1;">
                ğŸ“¥ ä»äº‘ç«¯æ¢å¤
            </button>
            <button onclick="startFullTest()" 
                    style="padding: 10px 15px; background: #9b59b6; color: white; border: none; border-radius: 5px; cursor: pointer; flex: 2;">
                ğŸ§ª å®Œæ•´äº‘åŒæ­¥æµ‹è¯•
            </button>
        </div>
    `;
}

// 3. ä¸€é”®æµ‹è¯•äº‘åŒæ­¥
async function startCloudSyncTest() {
    const confirmTest = confirm(`
å¼€å§‹äº‘åŒæ­¥æµ‹è¯•å—ï¼Ÿ

æµ‹è¯•æ­¥éª¤ï¼š
1. æ·»åŠ ä¸€ä¸ªæµ‹è¯•å·¥å…·
2. ä¿å­˜åˆ°äº‘ç«¯
3. æ¨¡æ‹Ÿæ¸…é™¤æœ¬åœ°æ•°æ®
4. ä»äº‘ç«¯æ¢å¤
5. éªŒè¯æ¢å¤ç»“æœ

ç‚¹å‡»"ç¡®å®š"å¼€å§‹æµ‹è¯•
    `);
    
    if (!confirmTest) return;
    
    // åˆ›å»ºæµ‹è¯•é¢æ¿
    const testModal = document.createElement('div');
    testModal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
    `;
    
    testModal.innerHTML = `
        <div style="
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
        ">
            <h2 style="margin-bottom: 20px; color: #2c3e50;">ğŸ§ª äº‘åŒæ­¥æµ‹è¯•</h2>
            
            <div id="testProgress" style="margin-bottom: 20px;">
                <div id="testStep1">1. å‡†å¤‡æµ‹è¯•å·¥å…·...</div>
                <div id="testStep2" style="margin-top: 10px;">2. ä¿å­˜åˆ°äº‘ç«¯...</div>
                <div id="testStep3" style="margin-top: 10px;">3. æ¨¡æ‹Ÿæ¸…é™¤æ•°æ®...</div>
                <div id="testStep4" style="margin-top: 10px;">4. ä»äº‘ç«¯æ¢å¤...</div>
                <div id="testStep5" style="margin-top: 10px;">5. éªŒè¯ç»“æœ...</div>
            </div>
            
            <div id="testResult" style="margin: 20px 0; padding: 15px; border-radius: 5px;"></div>
            
            <div style="text-align: center;">
                <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                        style="padding: 10px 20px; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer;">
                    å…³é—­
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(testModal);
    
    // å¼€å§‹æµ‹è¯•
    await runCloudSyncTest();
}

// 4. è¿è¡Œæµ‹è¯•çš„å…·ä½“é€»è¾‘
async function runCloudSyncTest() {
    const testStep1 = document.getElementById('testStep1');
    const testStep2 = document.getElementById('testStep2');
    const testStep3 = document.getElementById('testStep3');
    const testStep4 = document.getElementById('testStep4');
    const testStep5 = document.getElementById('testStep5');
    const testResult = document.getElementById('testResult');
    
    // æ­¥éª¤1ï¼šæ£€æŸ¥ç™»å½•çŠ¶æ€
    testStep1.innerHTML = 'âœ… 1. æ£€æŸ¥ç™»å½•çŠ¶æ€...';
    
    if (!currentUser) {
        testResult.innerHTML = `
            <div style="background: #f8d7da; padding: 15px; border-radius: 5px;">
                <strong>âŒ æµ‹è¯•å¤±è´¥</strong><br>
                è¯·å…ˆç™»å½•è´¦å·ï¼
            </div>
        `;
        return;
    }
    
    // å¤‡ä»½å½“å‰æ•°æ®
    const originalData = localStorage.getItem('toolbox-modules');
    
    // æ­¥éª¤2ï¼šæ·»åŠ æµ‹è¯•å·¥å…·
    testStep1.innerHTML = 'âœ… 1. æ·»åŠ æµ‹è¯•å·¥å…·...';
    
    const testToolName = `æµ‹è¯•å·¥å…· ${new Date().getHours()}:${new Date().getMinutes()}:${new Date().getSeconds()}`;
    const testTool = {
        id: 'test-tool-' + Date.now(),
        name: testToolName,
        url: 'https://example.com',
        icon: 'ğŸ§ª',
        desc: 'äº‘åŒæ­¥æµ‹è¯•'
    };
    
    // ç¡®ä¿æœ‰æ¨¡å—å¯ä»¥æ·»åŠ 
    if (currentModules.length === 0) {
        currentModules.push({
            id: 'test-module-' + Date.now(),
            name: 'æµ‹è¯•æ¨¡å—',
            icon: 'ğŸ§ª',
            layout: 'grid-layout',
            color: '#9b59b6',
            description: 'æµ‹è¯•ç”¨',
            tools: [testTool]
        });
    } else {
        currentModules[0].tools.push(testTool);
    }
    
    renderModules();
    
    // æ­¥éª¤3ï¼šä¿å­˜åˆ°äº‘ç«¯
    testStep2.innerHTML = 'âœ… 2. ä¿å­˜åˆ°äº‘ç«¯...';
    
    try {
        await saveToCloud();
        testStep2.innerHTML = 'âœ… 2. å·²ä¿å­˜åˆ°äº‘ç«¯';
    } catch (error) {
        testStep2.innerHTML = 'âŒ 2. ä¿å­˜å¤±è´¥';
        testResult.innerHTML = `
            <div style="background: #f8d7da; padding: 15px; border-radius: 5px;">
                <strong>âŒ ä¿å­˜å¤±è´¥</strong><br>
                é”™è¯¯: ${error.message}
            </div>
        `;
        return;
    }
    
    // ç­‰å¾…ä¸€ä¸‹ç¡®ä¿ä¿å­˜å®Œæˆ
    await new Promise(resolve => setTimeout(resolve, 1000));
    
    // æ­¥éª¤4ï¼šæ¨¡æ‹Ÿæ¸…é™¤æœ¬åœ°æ•°æ®
    testStep3.innerHTML = 'âœ… 3. æ¨¡æ‹Ÿæ¸…é™¤æœ¬åœ°æ•°æ®...';
    
    // å¤‡ä»½å½“å‰æ¨¡å—æ•°æ®
    const modulesBackup = [...currentModules];
    // æ¸…ç©ºæœ¬åœ°æ¨¡å—æ•°æ®
    currentModules = [];
    // åˆ é™¤localStorageä¸­çš„æ•°æ®
    localStorage.removeItem('toolbox-modules');
    
    // æ­¥éª¤5ï¼šä»äº‘ç«¯æ¢å¤
    testStep4.innerHTML = 'âœ… 4. ä»äº‘ç«¯æ¢å¤...';
    
    try {
        await loadUserDataFromCloud();
        testStep4.innerHTML = 'âœ… 4. ä»äº‘ç«¯æ¢å¤å®Œæˆ';
    } catch (error) {
        testStep4.innerHTML = 'âŒ 4. æ¢å¤å¤±è´¥';
        testResult.innerHTML = `
            <div style="background: #f8d7da; padding: 15px; border-radius: 5px;">
                <strong>âŒ æ¢å¤å¤±è´¥</strong><br>
                é”™è¯¯: ${error.message}
            </div>
        `;
        
        // æ¢å¤å¤‡ä»½
        currentModules = modulesBackup;
        localStorage.setItem('toolbox-modules', JSON.stringify(currentModules));
        renderModules();
        return;
    }
    
    // æ­¥éª¤6ï¼šéªŒè¯ç»“æœ
    testStep5.innerHTML = 'âœ… 5. éªŒè¯ç»“æœ...';
    
    // æ£€æŸ¥æ˜¯å¦æ¢å¤äº†æµ‹è¯•å·¥å…·
    let testToolFound = false;
    for (const module of currentModules) {
        if (module.tools) {
            for (const tool of module.tools) {
                if (tool.name === testToolName) {
                    testToolFound = true;
                    break;
                }
            }
        }
        if (testToolFound) break;
    }
    
    if (testToolFound) {
        testStep5.innerHTML = 'âœ… 5. éªŒè¯æˆåŠŸï¼';
        testResult.innerHTML = `
            <div style="background: #d4edda; padding: 15px; border-radius: 5px;">
                <strong>ğŸ‰ äº‘åŒæ­¥æµ‹è¯•æˆåŠŸï¼</strong><br><br>
                âœ… æµ‹è¯•å·¥å…·å·²ä¿å­˜åˆ°äº‘ç«¯<br>
                âœ… æœ¬åœ°æ•°æ®å·²æ¸…é™¤<br>
                âœ… ä»äº‘ç«¯æˆåŠŸæ¢å¤æ•°æ®<br>
                âœ… æµ‹è¯•å·¥å…· "${testToolName}" å·²æ¢å¤<br><br>
                <small>æ‚¨çš„äº‘åŒæ­¥åŠŸèƒ½å®Œå…¨æ­£å¸¸ï¼</small>
            </div>
        `;
    } else {
        testStep5.innerHTML = 'âŒ 5. éªŒè¯å¤±è´¥';
        testResult.innerHTML = `
            <div style="background: #f8d7da; padding: 15px; border-radius: 5px;">
                <strong>âŒ äº‘åŒæ­¥æµ‹è¯•å¤±è´¥</strong><br><br>
                æµ‹è¯•å·¥å…· "${testToolName}" æœªæ¢å¤<br><br>
                <small>å¯èƒ½çš„åŸå› ï¼š<br>
                1. æ•°æ®æœªæˆåŠŸä¿å­˜åˆ°äº‘ç«¯<br>
                2. äº‘ç«¯è¡¨ä¸å­˜åœ¨<br>
                3. æ¢å¤å‡½æ•°æœ‰é—®é¢˜</small>
            </div>
        `;
        
        // æ¢å¤åŸå§‹æ•°æ®
        if (originalData) {
            localStorage.setItem('toolbox-modules', originalData);
            loadModulesFromLocal();
            renderModules();
        }
    }
}

// 5. è¾…åŠ©å‡½æ•°
async function forceSaveToCloudTest() {
    if (!currentUser) {
        alert('è¯·å…ˆç™»å½•');
        return;
    }
    
    try {
        await saveToCloud();
        alert('âœ… æ•°æ®å·²ä¿å­˜åˆ°äº‘ç«¯');
        // åˆ·æ–°çŠ¶æ€æ˜¾ç¤º
        await checkCloudStatus();
    } catch (error) {
        alert('âŒ ä¿å­˜å¤±è´¥: ' + error.message);
    }
}

async function loadFromCloudTest() {
    if (!currentUser) {
        alert('è¯·å…ˆç™»å½•');
        return;
    }
    
    try {
        await loadUserDataFromCloud();
        alert('âœ… å·²ä»äº‘ç«¯æ¢å¤æ•°æ®');
        // åˆ·æ–°çŠ¶æ€æ˜¾ç¤º
        await checkCloudStatus();
    } catch (error) {
        alert('âŒ æ¢å¤å¤±è´¥: ' + error.message);
    }
}

async function startFullTest() {
    await startCloudSyncTest();
}



// ==================== ç«‹å³åŒæ­¥åŠŸèƒ½ ====================
async function manualCloudSync() {
    // æ£€æŸ¥æ˜¯å¦ç™»å½•
    if (!currentUser) {
        // æœªç™»å½•æ—¶æç¤ºç”¨æˆ·
        const shouldLogin = confirm('ğŸ”’ éœ€è¦ç™»å½•æ‰èƒ½ä½¿ç”¨äº‘åŒæ­¥åŠŸèƒ½\n\næ˜¯å¦ç«‹å³ç™»å½•ï¼Ÿ');
        if (shouldLogin) {
            showUserAuthModal();
        }
        return;
    }
    
    if (!supabaseClient) {
        alert('äº‘æœåŠ¡æœªé…ç½®ï¼Œæ— æ³•åŒæ­¥');
        return;
    }
    
    try {
        // æ˜¾ç¤ºåŒæ­¥çŠ¶æ€
        const syncToast = document.createElement('div');
        syncToast.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(52, 152, 219, 0.9);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            z-index: 9999;
            font-weight: bold;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            gap: 10px;
        `;
        syncToast.innerHTML = 'ğŸ”„ æ­£åœ¨åŒæ­¥åˆ°äº‘ç«¯...';
        document.body.appendChild(syncToast);
        
        // ä¿å­˜åˆ°äº‘ç«¯
        await saveToCloud();
        
        // æ›´æ–°æç¤º
        syncToast.innerHTML = 'âœ… åŒæ­¥å®Œæˆï¼';
        syncToast.style.background = 'rgba(46, 204, 113, 0.9)';
        
        // 3ç§’åç§»é™¤æç¤º
        setTimeout(() => {
            syncToast.remove();
        }, 3000);
        
    } catch (error) {
        console.error('åŒæ­¥å¤±è´¥:', error);
        
        // æ˜¾ç¤ºé”™è¯¯æç¤º
        const errorToast = document.createElement('div');
        errorToast.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(231, 76, 60, 0.9);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            z-index: 9999;
            font-weight: bold;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            gap: 10px;
        `;
        errorToast.innerHTML = 'âŒ åŒæ­¥å¤±è´¥ï¼š' + error.message;
        document.body.appendChild(errorToast);
        
        setTimeout(() => {
            errorToast.remove();
        }, 5000);
    }
}
        
        // ==================== å·¥å…·å‡½æ•° ====================
        
        function validateEmail(email) {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(email);
        }
        
        function getDefaultCloudConfig() {
            return {
                introduction: {
                    title: 'ğŸŒŸ æˆ‘çš„æ™ºèƒ½å·¥å…·ç®±',
                    content: 'è¿™æ˜¯ä¸€ä¸ªå®Œå…¨è‡ªå®šä¹‰çš„å·¥å…·ç®±ï¼Œæ”¯æŒäº‘å­˜å‚¨ï¼'
                },
                introBackground: {
                    color: '#667eea',
                    opacity: '90'
                },
                background: {
                    type: 'image',
                    image: '',
                    color: '#ffffff',
                    overlay: '15'
                },
                modules: getDefaultModules(),
                last_saved: new Date().toISOString()
            };
        }
        
        function getDefaultModules() {
            return [
                {
                    id: 'research-tools',
                    name: 'ç§‘ç ”å·¥å…·',
                    icon: 'ğŸ”¬',
                    layout: 'grid-layout',
                    color: '#27ae60',
                    description: 'ç§‘ç ”ç›¸å…³å·¥å…·',
                    tools: [
                        { id: 'tool-4', name: 'Google Earth Engine', url: 'https://earthengine.google.com', icon: 'ğŸŒ', desc: 'åœ°ç†åˆ†æ' },
                        { id: 'tool-5', name: 'USGS EarthExplorer', url: 'https://earthexplorer.usgs.gov', icon: 'ğŸ“¡', desc: 'é¥æ„Ÿæ•°æ®' },
                        { id: 'tool-6', name: 'GitHub', url: 'https://github.com', icon: 'ğŸ’»', desc: 'ä»£ç æ‰˜ç®¡' }
                    ]
                },
                {
                    id: 'search-tools',
                    name: 'æœç´¢å·¥å…·',
                    icon: 'ğŸŒ',
                    layout: 'grid-layout',
                    color: '#3498db',
                    description: 'å„ç±»ä¿¡æ¯æ£€ç´¢å·¥å…·',
                    tools: [
                        { id: 'tool-1', name: 'Google', url: 'https://google.com', icon: 'https://www.google.com/favicon.ico', desc: 'å…¨çƒæœç´¢' },
                        { id: 'tool-2', name: 'ç™¾åº¦', url: 'https://baidu.com', icon: 'ğŸ‡¨ğŸ‡³', desc: 'ä¸­æ–‡æœç´¢' },
                        { id: 'tool-3', name: 'Googleå­¦æœ¯', url: 'https://scholar.google.com', icon: 'ğŸ“š', desc: 'å­¦æœ¯æ–‡çŒ®' }
                    ]
                }
            ];
        }
        
        function loadModulesFromLocal() {
            const saved = localStorage.getItem('toolbox-modules');
            if (saved) {
                try {
                    currentModules = JSON.parse(saved);
                } catch (error) {
                    console.error('è§£ææœ¬åœ°æ¨¡å—å¤±è´¥:', error);
                    currentModules = getDefaultModules();
                }
            } else {
                currentModules = getDefaultModules();
            }
            renderModules();
        }
        
        // ==================== è‡ªåŠ¨ä¿å­˜ ====================
        
        function startAutoSave() {
            if (currentUser && supabaseClient && !autoSaveInterval) {
                autoSaveInterval = setInterval(async () => {
                    await saveToCloud();
                }, 30000); // æ¯30ç§’è‡ªåŠ¨ä¿å­˜ä¸€æ¬¡
            }
        }
        
        function stopAutoSave() {
            if (autoSaveInterval) {
                clearInterval(autoSaveInterval);
                autoSaveInterval = null;
            }
        }
        
        // ==================== æ¨¡æ€æ¡†æ§åˆ¶ ====================
        
function showUserAuthModal() {
    // åªè·å–ä¿å­˜çš„é‚®ç®±
    const savedEmail = localStorage.getItem('toolbox-login-email');
    
    // å¡«å……ç™»å½•è¡¨å•çš„é‚®ç®±
    document.getElementById('loginEmail').value = savedEmail || '';
    // å¯†ç è¾“å…¥æ¡†ä¿æŒä¸ºç©ºï¼Œä¸ä¿å­˜å¯†ç ï¼
    document.getElementById('loginPassword').value = '';
    
    // ç¡®ä¿å¯†ç è¾“å…¥æ¡†ç±»å‹æ­£ç¡®
    document.getElementById('loginPassword').type = 'password';
    document.getElementById('registerPassword').type = 'password';
    document.getElementById('registerConfirmPassword').type = 'password';
    
    // é‡ç½®å°çœ¼ç›å›¾æ ‡
    if (document.querySelectorAll('.toggle-password').length > 0) {
        document.querySelectorAll('.toggle-password').forEach(button => {
            button.textContent = 'ğŸ‘ï¸';
        });
    }
    
    // é‡ç½®æ³¨å†Œè¡¨å•
    document.getElementById('registerName').value = '';
    document.getElementById('registerEmail').value = '';
    document.getElementById('registerPassword').value = '';
    document.getElementById('registerConfirmPassword').value = '';
    document.getElementById('avatarPreview').innerHTML = '<div class="avatar-placeholder">ğŸ‘¤</div>';
    newUserAvatar = null;
    
    // é»˜è®¤æ˜¾ç¤ºç™»å½•æ ‡ç­¾
    switchAuthTab('login');
    document.getElementById('userAuthModal').style.display = 'flex';
}



        // ==================== ====================
        
        function closeUserAuthModal() {
            document.getElementById('userAuthModal').style.display = 'none';
        }
        
	function switchAuthTab(tab) {
	    // ç§»é™¤æ‰€æœ‰æ¿€æ´»çŠ¶æ€
	    document.getElementById('loginTab').classList.remove('active');
	    document.getElementById('registerTab').classList.remove('active');
	    document.getElementById('loginForm').classList.remove('active');
	    document.getElementById('registerForm').classList.remove('active');
    
	    // æ¿€æ´»é€‰ä¸­çš„æ ‡ç­¾
	    if (tab === 'login') {
	        document.getElementById('loginTab').classList.add('active');
	        document.getElementById('loginForm').classList.add('active');
	        
	        // å¦‚æœæ˜¯åˆ‡æ¢åˆ°ç™»å½•æ ‡ç­¾ï¼Œä¿æŒå·²æœ‰çš„ç™»å½•ä¿¡æ¯
	        const savedEmail = localStorage.getItem('toolbox-login-email');
        	const savedPassword = localStorage.getItem('toolbox-login-password');
	        if (savedEmail) {
	            document.getElementById('loginEmail').value = savedEmail;
        	}
	        if (savedPassword) {
        	    document.getElementById('loginPassword').value = savedPassword;
	        }	
	    } else {
	        document.getElementById('registerTab').classList.add('active');
        	document.getElementById('registerForm').classList.add('active');
        
	        // åˆ‡æ¢åˆ°æ³¨å†Œæ ‡ç­¾æ—¶æ¸…ç©ºç™»å½•è¡¨å•ï¼ˆå¯é€‰ï¼‰
	        document.getElementById('loginEmail').value = '';
        	document.getElementById('loginPassword').value = '';
	    }
	}
        
        // ==================== ä¿®æ”¹åŸæœ‰ä¿å­˜å‡½æ•°ä»¥æ”¯æŒäº‘å­˜å‚¨ ====================
        
        function saveModules() {
            localStorage.setItem('toolbox-modules', JSON.stringify(currentModules));
            if (currentUser) {
                saveToCloud();
            }
        }
        
        // ==================== åŸæœ‰æ‰€æœ‰å‡½æ•°ï¼ˆä¿æŒåŸæ ·ï¼‰ ====================
        
        // æœç´¢åŠŸèƒ½
        function selectSearchEngine(engine) {
            currentSearchEngine = engine;
            
            document.querySelectorAll('.search-engine-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-engine="${engine}"]`).classList.add('active');
            
            document.getElementById('searchBtnText').textContent = `${searchEngines[engine].name}æœç´¢`;
            
            updateSearchHint();
        }
        
        function toggleSiteSearch() {
            const toggle = document.getElementById('siteSearchToggle');
            isSiteSearchEnabled = toggle.checked;
            
            const searchInput = document.getElementById('searchInput');
            if (isSiteSearchEnabled) {
                searchInput.placeholder = 'ğŸ” æœç´¢å·¥å…·åç§°æˆ–æè¿°...';
                if (searchInput.value.trim()) {
                    performSearch();
                }
            } else {
                searchInput.placeholder = 'ğŸ” è¾“å…¥å…³é”®è¯æœç´¢...';
                hideSearchResults();
            }
            
            updateSearchHint();
        }
        
        function updateSearchHint() {
            const hintElement = document.getElementById('searchHint');
            if (isSiteSearchEnabled) {
                hintElement.innerHTML = `
                    <span class="search-hint-icon">ğŸ”</span>
                    <span>ç«™å†…æœç´¢æ¨¡å¼ï¼šæŒ‰ Enter é”®æˆ–ç‚¹å‡»æœç´¢æŒ‰é’®åœ¨å½“å‰å·¥å…·ç®±ä¸­æœç´¢</span>
                `;
            } else {
                hintElement.innerHTML = `
                    <span class="search-hint-icon">ğŸŒ</span>
                    <span>ç½‘é¡µæœç´¢æ¨¡å¼ï¼šæŒ‰ Enter é”®æˆ–ç‚¹å‡»æœç´¢æŒ‰é’®åœ¨ <strong>${searchEngines[currentSearchEngine].name}</strong> ä¸­æœç´¢</span>
                `;
            }
        }
        
        function handleSearchInput(event) {
            if (event.key === 'Enter') {
                performSearch();
                return;
            }
            
            clearTimeout(searchTimeout);
            
            if (isSiteSearchEnabled) {
                searchTimeout = setTimeout(function() {
                    const query = document.getElementById('searchInput').value.trim();
                    if (query.length > 0) {
                        performSiteSearch();
                    } else {
                        hideSearchResults();
                    }
                }, 300);
            } else {
                hideSearchResults();
            }
        }
        
        function performSearch() {
            const query = document.getElementById('searchInput').value.trim();
            
            if (!query) {
                if (isSiteSearchEnabled) {
                    hideSearchResults();
                }
                return;
            }
            
            if (isSiteSearchEnabled) {
                performSiteSearch();
            } else {
                performWebSearch();
            }
        }
        
        function performWebSearch() {
            const query = document.getElementById('searchInput').value.trim();
            const engine = searchEngines[currentSearchEngine];
            const searchUrl = engine.url + encodeURIComponent(query);
            
            window.open(searchUrl, '_blank');
        }
        
        function performSiteSearch() {
            const query = document.getElementById('searchInput').value.trim().toLowerCase();
            if (!query) {
                hideSearchResults();
                return;
            }
            
            const results = [];
            
            currentModules.forEach(module => {
                module.tools.forEach(tool => {
                    if (tool.name.toLowerCase().includes(query) || 
                        (tool.desc && tool.desc.toLowerCase().includes(query))) {
                        results.push({
                            tool: tool,
                            module: module
                        });
                    }
                });
            });
            
            displaySearchResults(results);
        }
        
        function displaySearchResults(results) {
            const resultsContainer = document.getElementById('searchResults');
            resultsContainer.innerHTML = '';
            
            if (results.length === 0) {
                resultsContainer.innerHTML = `
                    <div class="no-results">
                        <div>ğŸ” æœªæ‰¾åˆ°ç›¸å…³å·¥å…·</div>
                        <div style="font-size: 12px; margin-top: 5px;">å°è¯•ä½¿ç”¨å…¶ä»–å…³é”®è¯æˆ–åˆ‡æ¢åˆ°ç½‘é¡µæœç´¢</div>
                    </div>
                `;
            } else {
                results.forEach(result => {
                    const item = document.createElement('div');
                    item.className = 'search-result-item';
                    item.onclick = function() {
                        window.open(result.tool.url, '_blank');
                    };
                    
                    const icon = result.tool.icon.startsWith('http') || result.tool.icon.startsWith('data:image') ? 
                        `<img src="${result.tool.icon}" alt="${result.tool.name}" style="width: 20px; height: 20px;">` : 
                        result.tool.icon;
                    
                    item.innerHTML = `
                        <div class="search-result-icon">${icon}</div>
                        <div class="search-result-info">
                            <div class="search-result-name">${result.tool.name}</div>
                            <div class="search-result-desc">${result.tool.desc}</div>
                        </div>
                        <div class="search-result-module">${result.module.name}</div>
                    `;
                    
                    resultsContainer.appendChild(item);
                });
            }
            
            resultsContainer.style.display = 'block';
        }
        
        function hideSearchResults() {
            document.getElementById('searchResults').style.display = 'none';
        }
        
        // å›¾ç‰‡ä¸Šä¼ 
        function handleImageUpload(input) {
            const file = input.files[0];
            if (!file) return;
            
            const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/tiff', 'image/tif', 'image/webp'];
            if (!validTypes.includes(file.type)) {
                alert('è¯·ä¸Šä¼ æœ‰æ•ˆçš„å›¾ç‰‡æ–‡ä»¶ (æ”¯æŒæ ¼å¼: jpg, png, gif, tiff, webp)');
                input.value = '';
                return;
            }
            
            const maxSize = 3 * 1024 * 1024;
            if (file.size > maxSize) {
                const sizeInMB = (file.size / (1024 * 1024)).toFixed(2);
                alert(`å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡3MB\nå½“å‰å›¾ç‰‡: ${sizeInMB}MB\nè¯·å‹ç¼©å›¾ç‰‡åé‡æ–°ä¸Šä¼ `);
                input.value = '';
                document.getElementById('imageFileName').textContent = 'æ–‡ä»¶è¿‡å¤§ï¼Œè¯·é‡æ–°é€‰æ‹©';
                return;
            }
            
            const img = new Image();
            const reader = new FileReader();
            
            reader.onload = function(e) {
                img.onload = function() {
                    const maxWidth = 4000;
                    const maxHeight = 4000;
                    
                    if (this.width > maxWidth || this.height > maxHeight) {
                        alert(`å›¾ç‰‡å°ºå¯¸è¿‡å¤§\nå»ºè®®å°ºå¯¸: ä¸è¶…è¿‡${maxWidth}x${maxHeight}åƒç´ \nå½“å‰å°ºå¯¸: ${this.width}x${this.height}åƒç´ `);
                        input.value = '';
                        document.getElementById('imageFileName').textContent = 'å°ºå¯¸è¿‡å¤§ï¼Œè¯·é‡æ–°é€‰æ‹©';
                        return;
                    }
                    
                    uploadedBgImage = e.target.result;
                    document.getElementById('imageFileName').textContent = `å·²é€‰æ‹©: ${file.name} (${(file.size/1024).toFixed(1)}KB, ${this.width}x${this.height})`;
                    updateBgPreview();
                };
                img.onerror = function() {
                    alert('å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œè¯·é€‰æ‹©å…¶ä»–å›¾ç‰‡');
                    input.value = '';
                    document.getElementById('imageFileName').textContent = 'å›¾ç‰‡åŠ è½½å¤±è´¥';
                };
                img.src = e.target.result;
            };
            
            reader.readAsDataURL(file);
        }
        
        function handleToolIconUpload(input) {
            const file = input.files[0];
            if (!file) return;
            
            const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/tiff', 'image/tif', 'image/webp'];
            if (!validTypes.includes(file.type)) {
                alert('è¯·ä¸Šä¼ æœ‰æ•ˆçš„å›¾ç‰‡æ–‡ä»¶ (æ”¯æŒæ ¼å¼: jpg, png, gif, tiff, webp)');
                input.value = '';
                return;
            }
            
            const maxSize = 1 * 1024 * 1024;
            if (file.size > maxSize) {
                const sizeInMB = (file.size / (1024 * 1024)).toFixed(2);
                alert(`å›¾æ ‡å¤§å°ä¸èƒ½è¶…è¿‡1MB\nå½“å‰æ–‡ä»¶: ${sizeInMB}MB\nå»ºè®®ä½¿ç”¨å°å°ºå¯¸å›¾æ ‡`);
                input.value = '';
                document.getElementById('toolIconFileName').textContent = 'æ–‡ä»¶è¿‡å¤§ï¼Œè¯·é‡æ–°é€‰æ‹©';
                return;
            }
            
            const img = new Image();
            const reader = new FileReader();
            
            reader.onload = function(e) {
                img.onload = function() {
                    const maxSize = 200;
                    if (this.width > maxSize || this.height > maxSize) {
                        alert(`å›¾æ ‡å°ºå¯¸å»ºè®®ä¸è¶…è¿‡${maxSize}x${maxSize}åƒç´ \nå½“å‰å°ºå¯¸: ${this.width}x${this.height}åƒç´ `);
                    }
                    
                    uploadedToolIcon = e.target.result;
                    document.getElementById('toolIconFileName').textContent = 
                        `å·²é€‰æ‹©: ${file.name} (${(file.size/1024).toFixed(1)}KB, ${this.width}x${this.height})`;
                };
                img.onerror = function() {
                    alert('å›¾æ ‡åŠ è½½å¤±è´¥ï¼Œè¯·é€‰æ‹©å…¶ä»–å›¾ç‰‡');
                    input.value = '';
                    document.getElementById('toolIconFileName').textContent = 'å›¾ç‰‡åŠ è½½å¤±è´¥';
                };
                img.src = e.target.result;
            };
            
            reader.readAsDataURL(file);
        }
        
        // å…³äºæœ¬ç«™
        function showAboutModal() {
            document.getElementById('aboutModal').style.display = 'flex';
        }
        
        function closeAboutModal() {
            document.getElementById('aboutModal').style.display = 'none';
        }
        
       // å¯¼å‡ºé…ç½®æç¤ºåŠŸèƒ½
        function showExportHelp() {
            document.getElementById('exportHelpModal').style.display = 'flex';
        }
        
        function closeExportHelpModal() {
            document.getElementById('exportHelpModal').style.display = 'none';
        }
        
        function confirmExport() {
            closeExportHelpModal();
            setTimeout(exportConfig, 100);// çŸ­æš‚å»¶è¿Ÿåæ‰§è¡Œå¯¼å‡º
        }
        
        // æ—¶é—´æ˜¾ç¤º
        function updateGlobalTime() {
            const now = new Date();
            // æ ¼å¼åŒ–æ—¥æœŸï¼š2026å¹´1æœˆ28æ—¥ æ˜ŸæœŸä¸‰
            const year = now.getFullYear();
            const month = now.getMonth() + 1;
            const date = now.getDate();
            const day = now.getDay();
            const weekdays = ['æ˜ŸæœŸæ—¥', 'æ˜ŸæœŸä¸€', 'æ˜ŸæœŸäºŒ', 'æ˜ŸæœŸä¸‰', 'æ˜ŸæœŸå››', 'æ˜ŸæœŸäº”', 'æ˜ŸæœŸå…­'];
            const weekday = weekdays[day];
            
            document.getElementById('globalCurrentDate').textContent = `${year}å¹´${month}æœˆ${date}æ—¥ ${weekday}`;
              // æ ¼å¼åŒ–æ—¶é—´ï¼š16:01
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            
            document.getElementById('globalCurrentTime').textContent = `${hours}:${minutes}`;
        }
        
       // ä»‹ç»æ åŠŸèƒ½
        function loadIntroduction() {
            const title = localStorage.getItem('toolbox-intro-title');
            const content = localStorage.getItem('toolbox-intro-content');
            
            if (title) document.getElementById('introTitle').textContent = title;
            if (content) document.getElementById('introContent').textContent = content;
        }
        
        function loadIntroductionBackground() {
            const bgColor = localStorage.getItem('toolbox-intro-bg-color') || '#667eea';
            const bgOpacity = localStorage.getItem('toolbox-intro-bg-opacity') || '90';
            
            const introPanel = document.getElementById('introductionPanel');
            const color = hexToRgb(bgColor);
            introPanel.style.backgroundColor = `rgba(${color.r}, ${color.g}, ${color.b}, ${bgOpacity / 100})`;
            
            document.getElementById('introBgColor').value = bgColor;
            document.getElementById('introBgOpacity').value = bgOpacity;
            document.getElementById('introOpacityValue').textContent = bgOpacity + '%';
            
            updateIntroBgPreview();
        }
        
        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
            } : {r: 102, g: 126, b: 234}; // é»˜è®¤é¢œè‰²
        }
        
        function updateIntroBgPreview() {
            const color = document.getElementById('introBgColor').value;
            const opacity = document.getElementById('introBgOpacity').value;
            const rgb = hexToRgb(color);
            document.getElementById('introBgPreview').style.backgroundColor = 
                `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, ${opacity / 100})`;
        }
        
        function showIntroductionModal() {
            document.getElementById('introTitleInput').value = document.getElementById('introTitle').textContent;
            document.getElementById('introContentInput').value = document.getElementById('introContent').textContent;
            document.getElementById('introductionModal').style.display = 'flex';
        }
        
        function showIntroductionBackgroundModal() {
            document.getElementById('introductionBackgroundModal').style.display = 'flex';
        }
        
        function closeIntroductionModal() {
            document.getElementById('introductionModal').style.display = 'none';
        }
        
        function closeIntroductionBackgroundModal() {
            document.getElementById('introductionBackgroundModal').style.display = 'none';
        }
        
        function saveIntroduction() {
            const title = document.getElementById('introTitleInput').value.trim();
            const content = document.getElementById('introContentInput').value.trim();
            
            if (title) {
                document.getElementById('introTitle').textContent = title;
                localStorage.setItem('toolbox-intro-title', title);
            }
            
            if (content) {
                document.getElementById('introContent').textContent = content;
                localStorage.setItem('toolbox-intro-content', content);
            }
            
            // å¦‚æœæ˜¯ç™»å½•çŠ¶æ€ï¼Œä¿å­˜åˆ°äº‘ç«¯
            if (currentUser) {
                saveToCloud();
            }
            
            closeIntroductionModal();
        }
        
        function saveIntroductionBackground() {
            const bgColor = document.getElementById('introBgColor').value;
            const bgOpacity = document.getElementById('introBgOpacity').value;
            
            const introPanel = document.getElementById('introductionPanel');
            const color = hexToRgb(bgColor);
            introPanel.style.backgroundColor = `rgba(${color.r}, ${color.g}, ${color.b}, ${bgOpacity / 100})`;
            
            localStorage.setItem('toolbox-intro-bg-color', bgColor);
            localStorage.setItem('toolbox-intro-bg-opacity', bgOpacity);
            
            // å¦‚æœæ˜¯ç™»å½•çŠ¶æ€ï¼Œä¿å­˜åˆ°äº‘ç«¯
            if (currentUser) {
                saveToCloud();
            }
            
            closeIntroductionBackgroundModal();
        }
        
        function resetIntroductionBackground() {
            const defaultColor = '#667eea';
            const defaultOpacity = '90';
            
            document.getElementById('introBgColor').value = defaultColor;
            document.getElementById('introBgOpacity').value = defaultOpacity;
            document.getElementById('introOpacityValue').textContent = defaultOpacity + '%';
            
            const introPanel = document.getElementById('introductionPanel');
            const color = hexToRgb(defaultColor);
            introPanel.style.backgroundColor = `rgba(${color.r}, ${color.g}, ${color.b}, ${defaultOpacity / 100})`;
            
            localStorage.setItem('toolbox-intro-bg-color', defaultColor);
            localStorage.setItem('toolbox-intro-bg-opacity', defaultOpacity);
            
            // å¦‚æœæ˜¯ç™»å½•çŠ¶æ€ï¼Œä¿å­˜åˆ°äº‘ç«¯
            if (currentUser) {
                saveToCloud();
            }
            
            updateIntroBgPreview();
        }
        
        // èƒŒæ™¯åŠŸèƒ½
        function loadBackground() {
            const bgType = localStorage.getItem('toolbox-bg-type') || 'image';
            const bgImage = localStorage.getItem('toolbox-bg-image');
            const bgColor = localStorage.getItem('toolbox-bg-color') || '#ffffff';
            const bgOverlay = localStorage.getItem('toolbox-bg-overlay') || '15';
            
            currentBgType = bgType;
            selectBgType(bgType);
            
            if (bgType === 'image' && bgImage) {
                document.documentElement.style.setProperty('--bg-image', `url("${bgImage}")`);
                document.getElementById('bgImageUrl').value = bgImage;
            } else if (bgType === 'color') {
                document.documentElement.style.setProperty('--bg-color', bgColor);
                document.getElementById('bgColorPicker').value = bgColor;
                document.getElementById('colorPreview').style.background = bgColor;
            }
            
            document.documentElement.style.setProperty('--bg-overlay', `rgba(255, 255, 255, ${bgOverlay / 100})`);
            document.getElementById('bgOverlay').value = bgOverlay;
            document.getElementById('overlayValue').textContent = bgOverlay + '%';
            
            updateBgPreview();
        }
        
        function selectBgType(type) {
            currentBgType = type;
              // æ›´æ–°UI
            document.getElementById('bgTypeImage').classList.remove('active');
            document.getElementById('bgTypeColor').classList.remove('active');
            document.getElementById('bgType' + type.charAt(0).toUpperCase() + type.slice(1)).classList.add('active');
             // æ˜¾ç¤º/éšè—å¯¹åº”çš„è®¾ç½®åŒºåŸŸ           
            document.getElementById('imageBgSettings').style.display = type === 'image' ? 'block' : 'none';
            document.getElementById('colorBgSettings').style.display = type === 'color' ? 'block' : 'none';
            // æ›´æ–°é¢„è§ˆ   
            updateBgPreview();
        }
        
        function showBackgroundModal() {
            document.getElementById('backgroundModal').style.display = 'flex';
        }
        
        function closeBackgroundModal() {
            document.getElementById('backgroundModal').style.display = 'none';
            uploadedBgImage = null;
            document.getElementById('imageFileName').textContent = '';
        }
        
        function updateBgPreview() {
            const preview = document.getElementById('bgPreview');
            
            if (currentBgType === 'image') {
                const url = document.getElementById('bgImageUrl').value;
                if (uploadedBgImage) {
                    preview.style.backgroundImage = `url("${uploadedBgImage}")`;
                    preview.textContent = '';
                } else if (url) {
                    preview.style.backgroundImage = `url("${url}")`;
                    preview.textContent = '';
                } else {
                    preview.style.backgroundImage = 'none';
                    preview.textContent = 'å›¾ç‰‡èƒŒæ™¯é¢„è§ˆ';
                }
            } else {
                preview.style.backgroundImage = 'none';
                preview.textContent = 'çº¯è‰²èƒŒæ™¯é¢„è§ˆ';
            }
        }
        
        function saveBackground() {
            const bgOverlay = document.getElementById('bgOverlay').value;
             // ä¿å­˜èƒŒæ™¯ç±»å‹  
            localStorage.setItem('toolbox-bg-type', currentBgType);
            
            if (currentBgType === 'image') {
                let bgImage = document.getElementById('bgImageUrl').value.trim();
              // ä¼˜å…ˆä½¿ç”¨ä¸Šä¼ çš„å›¾ç‰‡
                if (uploadedBgImage) {
                    bgImage = uploadedBgImage;
                    localStorage.setItem('toolbox-bg-image-upload', uploadedBgImage);
                    
                    // æ£€æŸ¥Data URLé•¿åº¦é™åˆ¶
                    if (uploadedBgImage.length > 2 * 1024 * 1024) { // Data URLé•¿åº¦é™åˆ¶
                        alert('è­¦å‘Šï¼šå›¾ç‰‡Data URLè¾ƒå¤§ï¼Œå¯èƒ½ä¼šå½±å“é¡µé¢åŠ è½½é€Ÿåº¦ã€‚å»ºè®®ä½¿ç”¨è¾ƒå°çš„å›¾ç‰‡æˆ–å¤–éƒ¨é“¾æ¥ã€‚');
                    }
                }

                if (bgImage) {
                    if (bgImage.startsWith('http') || bgImage.startsWith('data:')) {
                        document.documentElement.style.setProperty('--bg-image', `url("${bgImage}")`);

                        localStorage.setItem('toolbox-bg-image', bgImage);
                    } else {
                        alert('å›¾ç‰‡é“¾æ¥æ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·ä½¿ç”¨å®Œæ•´çš„http/httpsé“¾æ¥æˆ–ä¸Šä¼ å›¾ç‰‡');
                        return;
                    }
                } else {
                    document.documentElement.style.setProperty('--bg-image', 'none');
                    localStorage.removeItem('toolbox-bg-image');
                }
                // æ¸…é™¤çº¯è‰²èƒŒæ™¯
                document.documentElement.style.setProperty('--bg-color', '#ffffff');
                localStorage.removeItem('toolbox-bg-color');
            } else {
                const bgColor = document.getElementById('bgColorPicker').value;
                document.documentElement.style.setProperty('--bg-color', bgColor);
                localStorage.setItem('toolbox-bg-color', bgColor);
                // æ¸…é™¤å›¾ç‰‡èƒŒæ™¯
                document.documentElement.style.setProperty('--bg-image', 'none');
                localStorage.removeItem('toolbox-bg-image');
                localStorage.removeItem('toolbox-bg-image-upload');
            }
            
            document.documentElement.style.setProperty('--bg-overlay', `rgba(255, 255, 255, ${bgOverlay / 100})`);
            localStorage.setItem('toolbox-bg-overlay', bgOverlay);
            
            // å¦‚æœæ˜¯ç™»å½•çŠ¶æ€ï¼Œä¿å­˜åˆ°äº‘ç«¯
            if (currentUser) {
                saveToCloud();
            }
            
            closeBackgroundModal();
        }
        
        function resetBackground() {
            currentBgType = 'image';
            selectBgType('image');
            
            document.documentElement.style.setProperty('--bg-image', 'none');
            document.documentElement.style.setProperty('--bg-color', '#ffffff');
            document.documentElement.style.setProperty('--bg-overlay', 'rgba(255, 255, 255, 0.85)');
            
            document.getElementById('bgImageUrl').value = '';
            document.getElementById('bgColorPicker').value = '#ffffff';
            document.getElementById('bgOverlay').value = '15';
            document.getElementById('overlayValue').textContent = '15%';
            document.getElementById('imageFileName').textContent = '';
            document.getElementById('colorPreview').style.background = '#ffffff';
            
            uploadedBgImage = null;
            
            localStorage.removeItem('toolbox-bg-image');
            localStorage.removeItem('toolbox-bg-image-upload');
            localStorage.removeItem('toolbox-bg-color');
            localStorage.setItem('toolbox-bg-type', 'image');
            localStorage.setItem('toolbox-bg-overlay', '15');
            
            // å¦‚æœæ˜¯ç™»å½•çŠ¶æ€ï¼Œä¿å­˜åˆ°äº‘ç«¯
            if (currentUser) {
                saveToCloud();
            }
            
            updateBgPreview();
        }
        
        // æ‹–æ‹½ç³»ç»Ÿ
        function initModuleDragAndDrop() {
            const container = document.getElementById('modulesContainer');
             // ä½¿ç”¨ Sortable.js å®ç°æ›´å¥½çš„æ‹–æ‹½         
            new Sortable(container, {
                animation: 150,
                ghostClass: 'dragging',
                chosenClass: 'dragging',
                dragClass: 'dragging',
                handle: isEditMode ? '.module' : false,
                disabled: !isEditMode,
                onEnd: function(evt) {
                    updateModuleOrder();
                }
            });
        }
        
        function initToolDragAndDrop(moduleElement) {
            const toolContainer = moduleElement.querySelector('.module-content');
            if (!toolContainer) return;
            
            new Sortable(toolContainer, {
                animation: 150,
                ghostClass: 'tool-dragging',
                chosenClass: 'tool-dragging',
                dragClass: 'tool-dragging',
                handle: isEditMode ? '.tool-item' : false,
                disabled: !isEditMode,
                onEnd: function(evt) {
                    updateToolOrderInModule(moduleElement);
                }
            });
        }
        
        function initDragAndDrop() {
            initModuleDragAndDrop();
            document.querySelectorAll('.module').forEach(module => {
                initToolDragAndDrop(module);
            });
        }
        
        // æ¨¡å—å’Œå·¥å…·ç®¡ç†åŠŸèƒ½
        function generateToolId() {
            return 'tool-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        }
        
        function loadModules() {
            const saved = localStorage.getItem('toolbox-modules');
            if (saved) {
                currentModules = JSON.parse(saved);
                
                // ç¡®ä¿æ¯ä¸ªå·¥å…·éƒ½æœ‰IDï¼ˆå…¼å®¹æ—§ç‰ˆæœ¬æ•°æ®ï¼‰
                currentModules.forEach(module => {
                    if (module.tools) {
                        module.tools.forEach(tool => {
                            if (!tool.id) {
                                tool.id = generateToolId();
                            }
                        });
                    }
                });
            } else {
                // é»˜è®¤æ¨¡å— - æ³¨æ„ï¼šç°åœ¨ç¬¬ä¸€ä¸ªæ¨¡å—ä¼šæ˜¾ç¤ºåœ¨æœ€ä¸Šé¢
                currentModules = [
                    {
                        id: 'research-tools',
                        name: 'ç§‘ç ”å·¥å…·',
                        icon: 'ğŸ”¬',
                        layout: 'grid-layout',
                        color: '#27ae60',
                        description: 'ç§‘ç ”ç›¸å…³å·¥å…·',
                        tools: [
                            { id: 'tool-4', name: 'Google Earth Engine', url: 'https://earthengine.google.com', icon: 'ğŸŒ', desc: 'åœ°ç†åˆ†æ' },
                            { id: 'tool-5', name: 'USGS EarthExplorer', url: 'https://earthexplorer.usgs.gov', icon: 'ğŸ“¡', desc: 'é¥æ„Ÿæ•°æ®' },
                            { id: 'tool-6', name: 'GitHub', url: 'https://github.com', icon: 'ğŸ’»', desc: 'ä»£ç æ‰˜ç®¡' }
                        ]
                    },
                    {
                        id: 'search-tools',
                        name: 'æœç´¢å·¥å…·',
                        icon: 'ğŸŒ',
                        layout: 'grid-layout',
                        color: '#3498db',
                        description: 'å„ç±»ä¿¡æ¯æ£€ç´¢å·¥å…·',
                        tools: [
                            { id: 'tool-1', name: 'Google', url: 'https://google.com', icon: 'https://www.google.com/favicon.ico', desc: 'å…¨çƒæœç´¢' },
                            { id: 'tool-2', name: 'ç™¾åº¦', url: 'https://baidu.com', icon: 'ğŸ‡¨ğŸ‡³', desc: 'ä¸­æ–‡æœç´¢' },
                            { id: 'tool-3', name: 'Googleå­¦æœ¯', url: 'https://scholar.google.com', icon: 'ğŸ“š', desc: 'å­¦æœ¯æ–‡çŒ®' }
                        ]
                    }
                ];
                saveModules();
            }
        }
        
        function saveModules() {
            localStorage.setItem('toolbox-modules', JSON.stringify(currentModules));
        }
        
        function renderModules() {
            const container = document.getElementById('modulesContainer');
            container.innerHTML = '';
            
            if (currentModules.length === 0) {
                container.innerHTML = `
                    <div class="empty-module" onclick="showAddModuleModal()">
                        <div class="empty-module-icon">ğŸ“¦</div>
                        <div>ç‚¹å‡»è¿™é‡Œæ·»åŠ ç¬¬ä¸€ä¸ªæ¨¡å—</div>
                        <div style="font-size: 14px; margin-top: 10px;">æˆ–ä½¿ç”¨ä¸Šæ–¹çš„"æ·»åŠ æ–°æ¨¡å—"æŒ‰é’®</div>
                    </div>
                `;
                return;
            }
            
            // æŒ‰é¡ºåºæ¸²æŸ“æ¨¡å—ï¼ˆç°åœ¨ç¬¬ä¸€ä¸ªæ˜¾ç¤ºåœ¨æœ€ä¸Šé¢ï¼‰
            currentModules.forEach(module => {
                container.appendChild(createModuleElement(module));
            });
            
            // åˆå§‹åŒ–æ‹–æ‹½æ’åºï¼ˆåœ¨ç¼–è¾‘æ¨¡å¼ä¸‹ï¼‰
            if (isEditMode) {
                initDragAndDrop();
            }
        }
        
        function createModuleElement(module) {
            const moduleDiv = document.createElement('div');
            moduleDiv.className = 'module';
            moduleDiv.id = module.id;
            moduleDiv.dataset.moduleId = module.id;
            
            // è®¾ç½®æ¨¡å—é¢œè‰²
            moduleDiv.style.setProperty('--module-color', module.color);
            
            // å·¥å…·é¡¹ç›®HTML - ç°åœ¨ä½¿ç”¨ç»Ÿä¸€çš„å°å‹å¡ç‰‡æ ·å¼
            let toolsHtml = '';
            if (module.tools && module.tools.length > 0) {
                module.tools.forEach(tool => {
                    toolsHtml += `
                        <a href="${tool.url}" target="_blank" class="tool-item" data-tool-id="${tool.id}">
                            <div class="tool-controls">
                                <button class="tool-edit-btn" onclick="editTool('${tool.id}', '${module.id}', event)">âœï¸</button>
                                <button class="tool-delete-btn" onclick="deleteTool('${tool.id}', '${module.id}', event)">Ã—</button>
                            </div>
                            <div class="tool-icon">
                                ${tool.icon.startsWith('http') || tool.icon.startsWith('data:image') ? 
                                    `<img src="${tool.icon}" alt="${tool.name}" onerror="this.style.display='none';this.parentElement.innerHTML='${tool.name.charAt(0)}';">` : 
                                    tool.icon}
                            </div>
                            <div class="tool-info">
                                <div class="tool-name">${tool.name}</div>
                                <div class="tool-desc">${tool.desc}</div>
                            </div>
                        </a>
                    `;
                });
            } else {
                toolsHtml = `
                    <div style="text-align: center; padding: 40px; color: #95a5a6;">
                        <div style="font-size: 48px; margin-bottom: 15px;">ğŸ“­</div>
                        <div>æš‚æ— å·¥å…·</div>
                        <button class="btn" onclick="addToolToModule('${module.id}')" style="margin-top: 15px;">
                            æ·»åŠ å·¥å…·
                        </button>
                    </div>
                `;
            }
            
            // å®Œæ•´æ¨¡å—HTML
            moduleDiv.innerHTML = `
                <div class="module-header">
                    <div class="module-title">
                        <span class="module-title-icon">${module.icon}</span>
                        <span>${module.name}</span>
                        ${module.description ? `<small style="color: #7f8c8d; font-weight: normal;">- ${module.description}</small>` : ''}
                    </div>
                    <div class="module-controls">
                        <button class="control-btn" onclick="editModule('${module.id}')" title="ç¼–è¾‘æ¨¡å—">âœï¸</button>
                        <button class="control-btn" onclick="addToolToModule('${module.id}')" title="æ·»åŠ å·¥å…·">â•</button>
                        <button class="control-btn" onclick="deleteModule('${module.id}')" title="åˆ é™¤æ¨¡å—">ğŸ—‘ï¸</button>
                    </div>
                </div>
                <div class="module-content ${module.layout}">
                    ${toolsHtml}
                </div>
            `;
            
            return moduleDiv;
        }
        
        // ç¼–è¾‘å·¥å…·åŠŸèƒ½
        function editTool(toolId, moduleId, event) {
            if (event) event.preventDefault();
            
            const module = currentModules.find(m => m.id === moduleId);
            if (!module) return;
            
            const tool = module.tools.find(t => t.id === toolId);
            if (!tool) return;
            
            editingTool = { ...tool, moduleId };
            
            document.getElementById('toolModalTitle').textContent = 'âœï¸ ç¼–è¾‘å·¥å…·';
            document.getElementById('toolModalSubmitBtn').textContent = 'ä¿å­˜æ›´æ”¹';
            document.getElementById('editingToolId').value = toolId;
            
            updateTargetModuleSelect();
            document.getElementById('targetModule').value = moduleId;
            document.getElementById('toolName').value = tool.name;
            document.getElementById('toolUrl').value = tool.url;
            document.getElementById('toolIcon').value = tool.icon.startsWith('http') || tool.icon.startsWith('data:image') ? '' : tool.icon;
            document.getElementById('toolDescription').value = tool.desc;
            
            uploadedToolIcon = null;
            document.getElementById('toolIconFileName').textContent = '';
            
            document.getElementById('addToolModal').style.display = 'flex';
        }
        
        function deleteTool(toolId, moduleId, event) {
            if (event) event.preventDefault();
            
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå·¥å…·å—ï¼Ÿ')) return;
            
            const module = currentModules.find(m => m.id === moduleId);
            if (module) {
                module.tools = module.tools.filter(t => t.id !== toolId);
                saveModules();
                renderModules();
            }
        }
        
        function saveTool() {
            const toolId = document.getElementById('editingToolId').value;
            const moduleId = document.getElementById('targetModule').value;
            const name = document.getElementById('toolName').value.trim();
            const url = document.getElementById('toolUrl').value.trim();
            let icon = document.getElementById('toolIcon').value.trim() || 'ğŸ”—';
            const desc = document.getElementById('toolDescription').value.trim();
            
            if (!name || !url) {
                alert('è¯·å¡«å†™å·¥å…·åç§°å’Œç½‘å€');
                return;
            }
            
            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                alert('ç½‘å€æ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·ä»¥ http:// æˆ– https:// å¼€å¤´');
                return;
            }
            
            // ä¼˜å…ˆä½¿ç”¨ä¸Šä¼ çš„å›¾æ ‡
            if (uploadedToolIcon) {
                icon = uploadedToolIcon;
            }
            
            const module = currentModules.find(m => m.id === moduleId);
            if (!module) {
                alert('æ¨¡å—ä¸å­˜åœ¨');
                return;
            }
            
            if (toolId) {
                // ç¼–è¾‘ç°æœ‰å·¥å…·
                const toolIndex = module.tools.findIndex(t => t.id === toolId);
                if (toolIndex !== -1) {
                    module.tools[toolIndex] = {
                        ...module.tools[toolIndex],
                        name,
                        url,
                        icon,
                        desc
                    };
                }
            } else {
                // æ·»åŠ æ–°å·¥å…·
                const newTool = {
                    id: generateToolId(),
                    name: name,
                    url: url,
                    icon: icon,
                    desc: desc
                };
                
                module.tools.push(newTool);
            }
            
            saveModules();
            renderModules();
            closeAddToolModal();
        }
        
        function updateToolOrderInModule(moduleElement) {
            const moduleId = moduleElement.dataset.moduleId;
            const module = currentModules.find(m => m.id === moduleId);
            
            if (!module) return;
            
            const toolContainer = moduleElement.querySelector('.module-content');
            if (!toolContainer) return;
            
            const toolItems = toolContainer.querySelectorAll('.tool-item');
            const newToolOrder = [];
            
            toolItems.forEach(item => {
                const toolId = item.dataset.toolId;
                const tool = module.tools.find(t => t.id === toolId);
                if (tool) newToolOrder.push(tool);
            });
            
            module.tools = newToolOrder;
            saveModules();
        }
        
        function toggleEditMode() {
            isEditMode = !isEditMode;
            document.body.classList.toggle('edit-mode', isEditMode);
            
            const editIcon = document.getElementById('editIcon');
            const editText = document.getElementById('editText');
            const modeIndicator = document.getElementById('modeIndicator');
            
            if (isEditMode) {
                editIcon.textContent = 'ğŸ”’';
                editText.textContent = 'é€€å‡ºç¼–è¾‘';
                modeIndicator.innerHTML = 'âœï¸ ç¼–è¾‘æ¨¡å¼';
                initDragAndDrop();
            } else {
                editIcon.textContent = 'âœï¸';
                editText.textContent = 'è¿›å…¥ç¼–è¾‘æ¨¡å¼';
                modeIndicator.innerHTML = 'ğŸ”’ æµè§ˆæ¨¡å¼';
                // é‡æ–°åˆå§‹åŒ–æ¨¡å—æ‹–æ‹½ï¼ˆç¦ç”¨çŠ¶æ€ï¼‰
                initModuleDragAndDrop();
            }
            
            // æ›´æ–°å·¥å…·é¡¹çš„å¯æ‹–æ‹½çŠ¶æ€
            document.querySelectorAll('.tool-item').forEach(item => {
                item.draggable = isEditMode;
            });
        }
        
        function updateModuleOrder() {
            const container = document.getElementById('modulesContainer');
            const moduleElements = container.querySelectorAll('.module');
            const newOrder = [];
            
            moduleElements.forEach(element => {
                const moduleId = element.dataset.moduleId;
                const module = currentModules.find(m => m.id === moduleId);
                if (module) newOrder.push(module);
            });
            
            currentModules = newOrder;
            saveModules();
        }
        
        // æ¨¡å—ç®¡ç†åŠŸèƒ½
        function showAddModuleModal() {
            document.getElementById('addModuleModal').style.display = 'flex';
            document.getElementById('moduleName').focus();
        }
        
        function closeAddModuleModal() {
            document.getElementById('addModuleModal').style.display = 'none';
            document.getElementById('moduleName').value = '';
            document.getElementById('moduleDescription').value = '';
        }
        
        function createNewModule() {
            const name = document.getElementById('moduleName').value.trim();
            const icon = document.getElementById('moduleIcon').value;
            const layout = document.getElementById('moduleLayout').value;
            const color = document.getElementById('moduleColor').value;
            const description = document.getElementById('moduleDescription').value.trim();
            
            if (!name) {
                alert('è¯·è¾“å…¥æ¨¡å—åç§°');
                return;
            }
            
            const newModule = {
                id: 'module-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9),
                name: name,
                icon: icon,
                layout: layout,
                color: color,
                description: description,
                tools: []
            };
            
            currentModules.push(newModule);
            saveModules();
            renderModules();
            updateTargetModuleSelect();
            closeAddModuleModal();
            
            if (currentModules.length === 1 && !isEditMode) {
                toggleEditMode();
            }
        }
        
        function showAddToolModal(moduleId = null) {
            updateTargetModuleSelect();
            
            // é‡ç½®è¡¨å•
            document.getElementById('toolModalTitle').textContent = 'ğŸ”§ æ·»åŠ æ–°å·¥å…·';
            document.getElementById('toolModalSubmitBtn').textContent = 'æ·»åŠ å·¥å…·';
            document.getElementById('editingToolId').value = '';
            document.getElementById('toolName').value = '';
            document.getElementById('toolUrl').value = '';
            document.getElementById('toolIcon').value = '';
            document.getElementById('toolDescription').value = '';
            document.getElementById('toolIconFileName').textContent = '';
            uploadedToolIcon = null;
            
            // å¦‚æœæŒ‡å®šäº†æ¨¡å—IDï¼Œåˆ™é€‰ä¸­è¯¥æ¨¡å—
            if (moduleId) {
                document.getElementById('targetModule').value = moduleId;
            } else if (currentModules.length > 0) {
                // é»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ªæ¨¡å—
                document.getElementById('targetModule').value = currentModules[0].id;
            }
            
            document.getElementById('addToolModal').style.display = 'flex';
            document.getElementById('toolName').focus();
        }
        
        function closeAddToolModal() {
            document.getElementById('addToolModal').style.display = 'none';
            editingTool = null;
        }
        
        function updateTargetModuleSelect() {
            const select = document.getElementById('targetModule');
            select.innerHTML = '';
            
            currentModules.forEach(module => {
                const option = document.createElement('option');
                option.value = module.id;
                option.textContent = `${module.icon} ${module.name}`;
                select.appendChild(option);
            });
        }
        
        function addToolToModule(moduleId) {
            showAddToolModal(moduleId);
        }
        
        function editModule(moduleId) {
            currentEditingModuleId = moduleId;
            const module = currentModules.find(m => m.id === moduleId);
            
            if (!module) return;
            
            document.getElementById('editModuleContent').innerHTML = `
                <div class="form-group">
                    <label>æ¨¡å—åç§°</label>
                    <input type="text" id="editModuleName" value="${module.name}">
                </div>
                
                <div class="form-group">
                    <label>æ¨¡å—å›¾æ ‡</label>
                    <select id="editModuleIcon">
                        <option value="ğŸ”¬" ${module.icon === 'ğŸ”¬' ? 'selected' : ''}>ğŸ”¬ ç§‘ç ”</option>
                        <option value="ğŸŒ" ${module.icon === 'ğŸŒ' ? 'selected' : ''}>ğŸŒ ç½‘ç»œ</option>
                        <option value="ğŸ“š" ${module.icon === 'ğŸ“š' ? 'selected' : ''}>ğŸ“š å­¦æœ¯</option>
                        <option value="ğŸ’¼" ${module.icon === 'ğŸ’¼' ? 'selected' : ''}>ğŸ’¼ åŠå…¬</option>
                        <option value="ğŸ®" ${module.icon === 'ğŸ®' ? 'selected' : ''}>ğŸ® å¨±ä¹</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>å¸ƒå±€æ ·å¼</label>
                    <select id="editModuleLayout">
                        <option value="grid-layout" ${module.layout === 'grid-layout' ? 'selected' : ''}>ç½‘æ ¼å¸ƒå±€</option>
                        <option value="list-layout" ${module.layout === 'list-layout' ? 'selected' : ''}>åˆ—è¡¨å¸ƒå±€</option>
                        <option value="card-layout" ${module.layout === 'card-layout' ? 'selected' : ''}>å¡ç‰‡å¸ƒå±€</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>ä¸»é¢˜é¢œè‰²</label>
                    <input type="color" id="editModuleColor" value="${module.color}">
                </div>
                
                <div class="form-group">
                    <label>æ¨¡å—æè¿°</label>
                    <textarea id="editModuleDescription" rows="3">${module.description || ''}</textarea>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn" onclick="saveModuleEdit()" style="flex: 1;">
                        ä¿å­˜æ›´æ”¹
                    </button>
                    <button class="btn btn-secondary" onclick="closeEditModuleModal()" style="flex: 1;">
                        å–æ¶ˆ
                    </button>
                </div>
            `;




            document.getElementById('editModuleModal').style.display = 'flex';
        }
        
        function saveModuleEdit() {
            const module = currentModules.find(m => m.id === currentEditingModuleId);
            
            if (module) {
                module.name = document.getElementById('editModuleName').value.trim();
                module.icon = document.getElementById('editModuleIcon').value;
                module.layout = document.getElementById('editModuleLayout').value;
                module.color = document.getElementById('editModuleColor').value;
                module.description = document.getElementById('editModuleDescription').value.trim();
                
                saveModules();
                renderModules();
                closeEditModuleModal();
            }
        }
        
        function closeEditModuleModal() {
            document.getElementById('editModuleModal').style.display = 'none';
            currentEditingModuleId = null;
        }
        
        function deleteModule(moduleId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ¨¡å—å—ï¼Ÿæ¨¡å—å†…çš„æ‰€æœ‰å·¥å…·ä¹Ÿä¼šè¢«åˆ é™¤ã€‚')) {
                return;
            }
            
            currentModules = currentModules.filter(m => m.id !== moduleId);
            saveModules();
            renderModules();
            updateTargetModuleSelect();
        }
        
        function exportConfig() {
            const config = {
                version: '5.0',
                exportDate: new Date().toISOString(),
                features: ['introduction', 'intro-background', 'background', 'module-drag', 'tool-drag', 'tool-edit', 'file-upload', 'color-bg', 'search', 'about', 'user-auth', 'cloud-sync'],
                introduction: {
                    title: document.getElementById('introTitle').textContent,
                    content: document.getElementById('introContent').textContent
                },
                introBackground: {
                    color: localStorage.getItem('toolbox-intro-bg-color') || '#667eea',
                    opacity: localStorage.getItem('toolbox-intro-bg-opacity') || '90'
                },
                background: {
                    type: localStorage.getItem('toolbox-bg-type') || 'image',
                    image: localStorage.getItem('toolbox-bg-image'),
                    color: localStorage.getItem('toolbox-bg-color') || '#ffffff',
                    overlay: localStorage.getItem('toolbox-bg-overlay') || '15'
                },
                modules: currentModules
            };
            
            const dataStr = JSON.stringify(config, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `æ™ºèƒ½å·¥å…·ç®±é…ç½®-${new Date().toISOString().slice(0,10)}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            alert('é…ç½®å¯¼å‡ºæˆåŠŸï¼\næ–‡ä»¶å·²ä¿å­˜ä¸ºï¼š' + exportFileDefaultName);
        }
        
        function importConfig() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(e) {
                const file = e.target.files[0];
                const reader = new FileReader();
                
                reader.onload = function(event) {
                    try {
                        const config = JSON.parse(event.target.result);
                        
                        if (confirm(`å°†å¯¼å…¥é…ç½®ï¼Œè¿™ä¼šè¦†ç›–å½“å‰æ‰€æœ‰è®¾ç½®ï¼Œç¡®å®šå—ï¼Ÿ`)) {
                            if (config.introduction) {
                                document.getElementById('introTitle').textContent = config.introduction.title;
                                document.getElementById('introContent').textContent = config.introduction.content;
                                localStorage.setItem('toolbox-intro-title', config.introduction.title);
                                localStorage.setItem('toolbox-intro-content', config.introduction.content);
                            }
                            
                            if (config.introBackground) {
                                localStorage.setItem('toolbox-intro-bg-color', config.introBackground.color || '#667eea');
                                localStorage.setItem('toolbox-intro-bg-opacity', config.introBackground.opacity || '90');
                            }
                            
                            if (config.background) {
                                localStorage.setItem('toolbox-bg-type', config.background.type || 'image');
                                if (config.background.image) {
                                    localStorage.setItem('toolbox-bg-image', config.background.image);
                                }
                                if (config.background.color) {
                                    localStorage.setItem('toolbox-bg-color', config.background.color);
                                }
                                localStorage.setItem('toolbox-bg-overlay', config.background.overlay || '15');
                            }
                            
                            currentModules = config.modules || [];
                            saveModules();
                            
                            loadIntroduction();
                            loadIntroductionBackground();
                            loadBackground();
                            renderModules();
                            updateTargetModuleSelect();
                            
                            alert('é…ç½®å¯¼å…¥æˆåŠŸï¼');
                        }
                    } catch (error) {
                        alert('å¯¼å…¥å¤±è´¥ï¼š' + error.message);
                    }
                };
                
                reader.readAsText(file);
            };
            
            input.click();
        }
    </script>
    
    <!-- å¼•å…¥ Supabase JS åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- å¼•å…¥ Sortable.js åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
</body>
</html>
